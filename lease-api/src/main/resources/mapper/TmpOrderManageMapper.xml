<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 引入接口，只要实现接口的方法就会调用对应接口方法的 select id -->
<mapper namespace="com.szyciov.lease.mapper.TmpOrderManageMapper">

    <!-- 根据机构权限查询订单列表-->
    <sql id="getOrderListByOrganSQL">
        and org_order.organid in
        (select org_organ.id from org_organ where org_organ.creditcode in
        (<choose>
        <!-- 普通 -->
        <when test="specialstate != 1">
            select
            org_organ.creditcode
            from
            le_roledataauthority,
            le_roleuser,
            le_user,
            org_organ
            where
            le_roledataauthority.status = 1
            and le_roleuser.status = 1
            and le_user.status = 1
            and le_user.id = le_roleuser.userid
            and le_roleuser.roleid = le_roledataauthority.roleid
            and le_roledataauthority.dynamicid = org_organ.id
            and le_user.account = #{account}
            and le_user.leasescompanyid = #{leasescompanyid}
            <if test='null != organId and "" != organId'>
                and org_organ.id = #{organId}
            </if>
        </when>
        <otherwise>
            <!-- 超管 -->
            select
            org_organ.creditcode
            from
            org_organ,
            org_organ_company_ref
            where
            org_organ.status=1
            and org_organ_company_ref.status=1
            and org_organ_company_ref.organid = org_organ.id
            and org_organ_company_ref.companyid = #{leasescompanyid}
            <if test='null != organId and "" != organId'>
                and org_organ.id = #{organId}
            </if>
        </otherwise>
    </choose>)
        )
    </sql>

	<!-- 当前订单列表查询 -->
	<select id="getOrgCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			date_format(org_order.updatetime, '%Y/%m/%d %H:%i') updatetime,ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
			and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
            <if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
		order by
			org_order.orderstatus asc, 
			case when org_order.orderstatus = '2' then org_order.usetime else '' end asc,
			case when org_order.orderstatus != '2' then org_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
            <if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 待复核订单列表查询 -->
	<select id="getOrgAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.paytype, org_order.reviewperson, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.plateno, org_order.shouldpayamount, ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.times reviewtimes, tmp.counttimes reviewcounttimes,
			tmp.id reviewid,ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
			order by
				org_order.updatetime asc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 已复核订单列表查询 -->
	<select id="getOrgWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.reviewperson, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage,
        case when rawtmp.pricecopy is null or rawtmp.pricecopy = '' then org_order.pricecopy else rawtmp.pricecopy end pricecopy,
        org_order.originalorderamount, org_order.shouldpayamount, org_order.actualpayamount,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_order.originalorderamount, tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes,
			rawtmp.rawtimes, rawtmp.rawstarttime, rawtmp.rawendtime, rawtmp.rawmileage, tmp.id reviewid,
            ifnull(pub_dictionary.text, '运管平台') shortname, tmp.rawpricecopy
		from
			org_order left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
			left join (select * from (select * from org_orderreview order by createtime asc) orderReivew group by orderno) rawtmp on org_order.orderno = rawtmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus = "4"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
			order by
				org_order.updatetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus = "4"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
			</if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 已完成订单列表查询 -->
	<select id="getOrgCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.paymentstatus, org_order.paytype, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy, org_order.factmodelname,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.cancelparty, org_order.reviewstatus, org_order.paymethod, org_orderpaymentrecord.tradeno,
			org_order.factmodelname, org_order.shouldpayamount, pub_driver.jobnum, org_order.plateno, org_order.estimatedtime, org_order.estimatedmileage,
			date_format(org_order.undertime, '%Y-%m-%d %H:%i') undertime,
			date_format(org_order.ordertime, '%Y-%m-%d %H:%i') ordertime,
			ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            ifnull(pub_dictionary.text, '/') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
			left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
			left join pub_driver on org_order.driverid = pub_driver.id
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='orderstatus == "8"'>
				and org_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and org_order.paymentstatus = #{orderstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != cancelparty and (cancelparty == "3" or cancelparty == "4")'>
				and org_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != cancelparty and cancelparty == "0,2"'>
				and org_order.cancelparty in ("0", "2")
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != tradeno and "" != tradeno'>
				 and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
			order by
				org_order.orderstatus, org_order.usetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='orderstatus == "8"'>
				and org_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and org_order.paymentstatus = #{orderstatus}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != cancelparty and (cancelparty == "3" or cancelparty == "4")'>
				and org_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != cancelparty and cancelparty == "0,2"'>
				and org_order.cancelparty in ("0", "2")
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != tradeno and "" != tradeno'>
				 and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 待收款订单列表查询 -->
	<select id="getOrgWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.organid, org_order.paytype,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.reviewstatus, org_order.paymethod, org_order.plateno, org_order.shouldpayamount,
			ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus = "7"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
			order by
				org_order.paymentstatus desc, org_order.usetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus = "7"
            and org_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
        <include refid="getOrderListByOrganSQL"></include>
	</select>

</mapper>