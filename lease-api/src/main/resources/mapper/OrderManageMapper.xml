<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 引入接口，只要实现接口的方法就会调用对应接口方法的 select id -->
<mapper namespace="com.szyciov.lease.mapper.OrderManageMapper">
	<select id="getPubDriver" parameterType="String" resultType="PubDriver">
	SELECT * FROM pub_driver where status = 1 AND id = #{id}
	</select>
	<!-- 根据机构权限查询订单列表-->
	<sql id="getOrderListByOrganSQL">
		and org_order.organid in 
		(select org_organ.id from org_organ where org_organ.creditcode in 
			(<choose>
				<!-- 普通 -->
			    <when test="specialstate != 1">
			        select
						org_organ.creditcode
					from
						le_roledataauthority,
						le_roleuser,
						le_user,
						org_organ
					where
					le_roledataauthority.status = 1
					and le_roleuser.status = 1
					and le_user.status = 1
					and le_user.id = le_roleuser.userid
					and le_roleuser.roleid = le_roledataauthority.roleid
					and le_roledataauthority.dynamicid = org_organ.id
					and le_user.account = #{account}
					and le_user.leasescompanyid = #{leasescompanyid}
					<if test='null != organId and "" != organId'>
						and org_organ.id = #{organId}
					</if>
			     </when>
			     <otherwise>
			     	<!-- 超管 -->
					select
						org_organ.creditcode
					from
						org_organ,
						org_organ_company_ref
					where
					org_organ.status=1
					and org_organ_company_ref.status=1
					and org_organ_company_ref.organid = org_organ.id
					and org_organ_company_ref.companyid = #{leasescompanyid}
					<if test='null != organId and "" != organId'>
						and org_organ.id = #{organId}
					</if>
			     </otherwise>
			</choose>)
		)
	</sql>

	<!-- 待人工派单列表查询 -->
	<select id="getOrgLabourOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			date_format(org_order.undertime, '%Y-%m-%d %H:%i') undertime,
			org_order.pushnumber, org_order.orderstatus,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ("0", "1")
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
		order by
			org_order.createtime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgLabourOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ("0", "1")
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 当前订单列表查询 -->
	<select id="getOrgCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			date_format(org_order.updatetime, '%Y/%m/%d %H:%i') updatetime,ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
		order by
			org_order.orderstatus asc, 
			case when org_order.orderstatus = '2' then org_order.usetime else '' end asc,
			case when org_order.orderstatus != '2' then org_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 待复核订单列表查询 -->
	<select id="getOrgAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.paytype, org_order.reviewperson, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.plateno, org_order.shouldpayamount, ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.times reviewtimes, tmp.counttimes reviewcounttimes,
			tmp.id reviewid,ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.updatetime asc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1"))
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 已复核订单列表查询 -->
	<select id="getOrgWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.reviewperson, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage,
        case when rawtmp.pricecopy is null or rawtmp.pricecopy = '' then org_order.pricecopy else rawtmp.pricecopy end pricecopy,
        org_order.originalorderamount, org_order.shouldpayamount, org_order.actualpayamount,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_order.originalorderamount, tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes,
			rawtmp.rawtimes, rawtmp.rawstarttime, rawtmp.rawendtime, rawtmp.rawmileage, tmp.id reviewid,
            ifnull(pub_dictionary.text, '运管平台') shortname, tmp.rawpricecopy
		from
			org_order left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
			left join (select * from (select * from org_orderreview order by createtime asc) orderReivew group by orderno) rawtmp on org_order.orderno = rawtmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus = "4"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.updatetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus = "4"
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
			</if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 已完成订单列表查询 -->
	<select id="getOrgCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.paymentstatus, org_order.paytype, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy, org_order.factmodelname,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername,
			date_format(org_order.usetime, '%Y-%m-%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.cancelparty, org_order.reviewstatus, org_order.paymethod, org_orderpaymentrecord.tradeno,
			org_order.factmodelname, org_order.shouldpayamount, pub_driver.jobnum, org_order.plateno, org_order.estimatedtime, org_order.estimatedmileage,
			date_format(org_order.undertime, '%Y-%m-%d %H:%i') undertime,
			date_format(org_order.ordertime, '%Y-%m-%d %H:%i') ordertime,
			ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            ifnull(pub_dictionary.text, '/') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
			left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
			left join pub_driver on org_order.driverid = pub_driver.id
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
			
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='orderstatus == "8"'>
				and org_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and org_order.paymentstatus = #{orderstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != cancelparty and (cancelparty == "3" or cancelparty == "4")'>
				and org_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != cancelparty and cancelparty == "0,2"'>
				and org_order.cancelparty in ("0", "2")
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != tradeno and "" != tradeno'>
				 and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.orderstatus, org_order.usetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
			
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='orderstatus == "8"'>
				and org_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and org_order.paymentstatus = #{orderstatus}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != cancelparty and (cancelparty == "3" or cancelparty == "4")'>
				and org_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != cancelparty and cancelparty == "0,2"'>
				and org_order.cancelparty in ("0", "2")
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != tradeno and "" != tradeno'>
				 and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 待收款订单列表查询 -->
	<select id="getOrgWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.organid, org_order.paytype,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy,
			date_format(org_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(org_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
			date_format(org_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.oncity) oncity,
			org_order.oncity, org_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = org_order.offcity) offcity,
			org_order.offcity, org_order.offaddress, org_order.reviewstatus, org_order.paymethod, org_order.plateno, org_order.shouldpayamount,
			ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            ifnull(pub_dictionary.text, '运管平台') shortname
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = org_order.belongleasecompany
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus = "7"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.paymentstatus desc, org_order.usetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus = "7"
			<if test='usetype == "0"'>
				and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
			</if>
			<if test='usetype == "1"'>
				and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>

        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(org_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>

			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != paymethod and "" != paymethod'>
				and org_order.paymethod = #{paymethod}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and org_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and org_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<select id="getOrgOrderByOrderno" resultType="map" parameterType="String">
		select 
			a.*, b.nickname, b.account, d.name drivername, d.phone driverphone, pub_dictionary.value vehiclessubjectvalue,
			(select city from pub_cityaddr where pub_cityaddr.id = a.oncity) oncityName, 
			(select city from pub_cityaddr where pub_cityaddr.id = a.offcity) offcityName,
			ifnull(tmp.price, 0) price, tmp.starttime reviewstarttime, tmp.endtime reviewendtime, tmp.times reviewtimes, tmp.counttimes reviewcounttimes,
			tmp.mileage reviewmileage, tmp.timesubsidies reviewtimesubsidies, tmp.mileageprices reviewmileageprices,ifnull(dic2.text, '运管平台') belongleasecompanytext
		from
			org_order a left join org_user b on a.userid = b.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp
				on a.orderno = tmp.orderno
			left join pub_driver d on a.driverid = d.id
			left join pub_dictionary on a.vehiclessubjecttype = pub_dictionary.id
			left join pub_dictionary dic2 on dic2.id = a.belongleasecompany
		where a.status = 1 and a.orderno = #{orderno} limit 1
	</select>
	
	<select id="getOrgOrder" resultType="OrgOrder" parameterType="String">
		select * from org_order t where t.`status` = 1 and t.orderno = #{orderno}
	</select>
	
	<select id="getOrgUser" parameterType="map" resultType="map">
		select id, if(isnull(nickname) || nickname = '', account, concat(nickname, " ", account)) text from org_user
		where organid in 
		(
			select id from org_organ 
			where creditcode in 
				(
					select creditcode from org_organ where id in 
						(select organid from org_organ_company_ref where companyid = #{leasescompanyid} and status = 1)
				)
			and status = 1
			<if test="organId != null and organId != ''">
				and creditcode = (select creditcode from org_organ where id = #{organId} and status = 1)
			</if>
		)
		and status = 1 and usertype = '0'
		<if test="userName != null and userName != ''">
			and (nickname like "%"#{userName}"%" or account like "%"#{userName}"%")
		</if>
	</select>
	
	<sql id="getVehicleModelRulesSQL">
		from
			le_accountrules left join le_company_rules_ref on le_accountrules.rulesrefid = le_company_rules_ref.id
			left join le_vehiclemodels on le_accountrules.cartype = le_vehiclemodels.id
		where
			le_accountrules.status = 1 and le_company_rules_ref.status = 1 and le_vehiclemodels.status = 1
			and le_accountrules.leasescompanyid = #{leasescompanyid} and le_accountrules.city = #{oncity}
			and le_accountrules.rulestype = #{orderType} and le_accountrules.rulesstate = "0"
			and le_company_rules_ref.leasescompanyid = #{leasescompanyid} and le_company_rules_ref.organid = #{organId}
			and le_company_rules_ref.rulestate = "1" and le_vehiclemodels.modelstatus = "0"
			and le_vehiclemodels.leasescompanyid = #{leasescompanyid} and le_accountrules.type = "1"
			group by le_vehiclemodels.id
	</sql>
	<sql id="getVehicleModelSQL">
		from
			le_accountrules left join le_vehiclemodels on le_accountrules.cartype = le_vehiclemodels.id
		where
			le_accountrules.status = 1 and le_vehiclemodels.status = 1
			and le_accountrules.leasescompanyid = #{leasescompanyid} and le_accountrules.city = #{oncity}
			and le_accountrules.rulestype = #{orderType} and le_accountrules.rulesstate = "0"
			and le_vehiclemodels.modelstatus = "0" and le_vehiclemodels.leasescompanyid = #{leasescompanyid}
			 and le_accountrules.type = "0"
			group by le_vehiclemodels.id
	</sql>
	<select id="getCompanyVehicleModel" parameterType="map" resultType="map">
		<if test='null != usetype and usetype == "0"'>
			select
				le_vehiclemodels.id, le_vehiclemodels.name text
			<include refid="getVehicleModelRulesSQL"></include>
		</if>
		<if test='null != usetype and usetype == "1"'>
			select
				le_vehiclemodels.id, le_vehiclemodels.name text
			<include refid="getVehicleModelSQL"></include>
		</if>
	</select>
	
	<select id="getOrgWaitingOrderByOrderno" resultType="map" parameterType="String">
		SELECT
			a.*, b.nickname,
			b.account,
			c.`name` vehiclemodelname,
			(select text from pub_dictionary t1 where t1.id = a.oncity and t1.`status` = 1) oncityname,
			(select text from pub_dictionary t1 where t1.id = a.offcity and t1.`status` = 1) offcityname
		FROM
			org_order a,
			org_user b,
			le_vehiclemodels c
		WHERE
			a.userid = b.id
		AND a.selectedmodel = c.Id
		AND a.`status` = 1
		AND b.`Status` = 1
		AND c.`Status` = 1
		AND a.orderno = #{orderno} limit 1
	</select>
	
	<select id="getOrgDriverByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select a.id driverid, a.name drivername, a.workstatus, a.lat, a.lng, a.phone, a.headportraitmin, a.headportraitmax, concat(e.name, '.', d.name) brandname, g.name modelname,
		concat(
			(select m.text from pub_dictionary m where c.platenoprovince = m.value and m.type = "车牌省"),
			(select k.text from pub_dictionary k where c.platenocity = k.value and k.type = "车牌市"),
			c.plateno
		) plateno, g.id modelsid, c.id vehicleid
		from pub_driver a left join pub_driver_vehicle_ref b on a.id = b.driverid
		left join pub_vehicle c on b.vehicleid = c.id
		left join pub_vehcline d on c.vehclineid = d.id
		left join pub_vehcbrand e on d.vehcBrandID = e.Id
		left join le_vehcline_models_ref f on d.Id = f.vehclineid
		left join le_vehiclemodels g on f.vehiclemodelsid = g.Id
		left join pub_vehicle_scope h on c.id = h.vehicleid
		where  a.status = 1 and b.status = 1 and c.status = 1
		and d.status = 1 and f.status = 1 and g.status = 1 and h.status = 1 and a.workstatus in ("0", "2")
		and a.phone not in (select org_user.account from org_user where org_user.id = #{userId} and org_user.status = 1)
		and a.vehicletype = "0" and a.platformtype = "1"
		and g.id in (
			<if test='null != usetype and usetype == "0"'>
				select
					le_vehiclemodels.id
				<include refid="getVehicleModelRulesSQL"></include>
			</if>
			<if test='null != usetype and usetype == "1"'>
				select
					le_vehiclemodels.id
				<include refid="getVehicleModelSQL"></include>
			</if>
		)
		<if test="driverid != null and driverid != ''">
			and a.id != #{driverid}
		</if>
		<if test="oncity != null and oncity != ''">
			and (h.cityid = #{oncity}
			<if test="offcity != null and offcity != ''">
				or h.cityid = #{offcity}
			</if>
			)
		</if>
		<if test="leasescompanyid != null and leasescompanyid != ''">
			and a.leasescompanyid = #{leasescompanyid}
		</if>
		<if test="driverState != null and driverState != ''">
			and a.workstatus = #{driverState}
		</if>
		<if test="selectedmodel != null and selectedmodel != ''">
			and g.id = #{selectedmodel}
		</if>
		<if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
		<![CDATA[
			and a.lat >= ${minLat} and a.lat <= ${maxLat}
		]]>
		</if>
		<if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
		<![CDATA[
			and a.lng >= ${minLon} and a.lng <= ${maxLon}
		]]>
		</if>
		<if test="driverName != null and driverName != ''">
			and a.name like "%"#{driverName}"%"
		</if>
		<if test="models == 1">
			and g.level >= (select level from le_vehiclemodels where id = #{orderSelectedmodel})
		</if>
		<if test="models == 0">
			and g.id = #{orderSelectedmodel}
		</if>
        <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
            and a.belongleasecompany = #{queryTmpBelongleasecompany}
        </if>
		and a.lng &gt; 0 and a.lat &gt; 0
		group by a.id
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	
	<select id="getOrgDriverCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) 
		from 
		(select a.* from pub_driver a left join pub_driver_vehicle_ref b on a.id = b.driverid
		left join pub_vehicle c on b.vehicleid = c.id
		left join pub_vehcline d on c.vehclineid = d.id
		left join pub_vehcbrand e on d.vehcBrandID = e.Id
		left join le_vehcline_models_ref f on d.Id = f.vehclineid
		left join le_vehiclemodels g on f.vehiclemodelsid = g.Id
		left join pub_vehicle_scope h on c.id = h.vehicleid
		where  a.status = 1 and b.status = 1 and c.status = 1
		and d.status = 1 and f.status = 1 and g.status = 1 and h.status = 1 and a.workstatus in ("0", "2")
		and a.phone not in (select org_user.account from org_user where org_user.id = #{userId} and org_user.status = 1)
		and a.vehicletype = "0" and a.platformtype = "1"
		and g.id in (
			<if test='null != usetype and usetype == "0"'>
				select
					le_vehiclemodels.id
				<include refid="getVehicleModelRulesSQL"></include>
			</if>
			<if test='null != usetype and usetype == "1"'>
				select
					le_vehiclemodels.id
				<include refid="getVehicleModelSQL"></include>
			</if>
		)
		<if test="driverid != null and driverid != ''">
			and a.id != #{driverid}
		</if>
		<if test="oncity != null and oncity != ''">
			and (h.cityid = #{oncity}
			<if test="offcity != null and offcity != ''">
				or h.cityid = #{offcity}
			</if>
			)
		</if>
		<if test="leasescompanyid != null and leasescompanyid != ''">
			and a.leasescompanyid = #{leasescompanyid}
		</if>
		<if test="driverState != null and driverState != ''">
			and a.workstatus = #{driverState}
		</if>
		<if test="selectedmodel != null and selectedmodel != ''">
			and g.id = #{selectedmodel}
		</if>
		<if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
		<![CDATA[
			and a.lat >= ${minLat} and a.lat <= ${maxLat}
		]]>
		</if>
		<if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
		<![CDATA[
			and a.lng >= ${minLon} and a.lng <= ${maxLon}
		]]>
		</if>
		<if test="driverName != null and driverName != ''">
			and a.name like "%"#{driverName}"%"
		</if>
		<if test="models == 1">
			and g.level >= (select level from le_vehiclemodels where id = #{orderSelectedmodel})
		</if>
		<if test="models == 0">
			and g.id = #{orderSelectedmodel}
		</if>
        <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
            and a.belongleasecompany = #{queryTmpBelongleasecompany}
        </if>
		and a.lng &gt; 0 and a.lat &gt; 0
		group by a.id) tmp
	</select>
	
	<update id="manualSendOrder"  parameterType="map">
		update org_order set driverid=#{driverid}, orderstatus='2', pricemodel = #{pricemodel}, factmodel = #{factmodel}, pricecopy = #{pricecopy},
		vehicleid = #{vehicleid}, updatetime = now(), ordertime = now(), isusenow = #{isusenow} where orderno=#{orderno}
	</update>
	
	<update id="cancelOrgOrder"  parameterType="String">
		update org_order set orderstatus='8', cancelparty='0', updatetime=now(), canceltime=now(), ordertime = now() where orderno=#{orderno}
	</update>
	
	<select id="getOrgSendOrderRecord" resultType="map" parameterType="String">
		select id, orderno, driverid, reason, operator, date_format(createtime, '%Y-%m-%d %H:%i') createtime, updatetime, status, 
		(select t1.nickname from le_user t1 where t.operator = t1.id) operatorname,
		(select CONCAT(t1.`name`,' ', t1.phone) from pub_driver t1 where t.driverid = t1.id) driverinfo
		from org_sendrecord t
		where orderno = #{orderno} and status = 1 limit 1
	</select>
	
	<select id="getOrgChangeDriverListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*,
		(select CONCAT(t1.`name`, ' ', t1.phone) from pub_driver t1 where t1.id = t.beforedriverid) beforedriverinfo,  
		(select CONCAT(t1.`name`, ' ', t1.phone) from pub_driver t1 where t1.id = t.afterdriverid) afterdriverinfo,
		(select t1.nickname from le_user t1 where t.operator = t1.id and t1.`status` = 1) operatorname,
		date_format(t.sendtime, '%Y/%m/%d %H:%i') changetime
		from org_driverchanges t, (select @rownum :=0) b
		where orderno = #{orderNo} and status = 1 order by createtime desc
	</select>
	
	<select id="getOrgChangeDriverListCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from org_driverchanges where orderno = #{orderNo} and status = 1
	</select>
	
	<select id="getOrgOrderReviewListRecord" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*, (select t1.nickname from le_user t1 where t1.id = t.operator) operatorname,
		(select pricecopy from org_order where orderno = #{orderNo}) pricecopy
		from org_orderreview t, (select @rownum :=0) b where orderno = #{orderNo} and `status` = 1
		
		<if test="reviewstatus != null and reviewstatus != ''">
			and t.reviewstatus = #{reviewstatus}
		</if>
		order by reviewtime desc
	</select>
	
	<select id="getOrgOrderReviewListCountRecord" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) 
		from org_orderreview t where orderno = #{orderNo} and `status` = 1
		
		<if test="reviewstatus != null and reviewstatus != ''">
			and t.reviewstatus = #{reviewstatus}
		</if>
	</select>
	
	<insert id="applyOrgOrderReview" parameterType="OrgOrderReview">
		INSERT INTO org_orderreview 
		(id, orderno, price, mileage, times, starttime, endtime, counttimes, timesubsidies, mileageprices, reviewperson, reason, reviewtime,
		operator, createtime, updatetime, status, reviewstatus, rawstarttime, rawendtime, rawtimes, rawmileage, reviewedprice, opinion, raworderamount,
		pricecopy, rawpricecopy)
		VALUES 
		(#{id}, #{orderno}, #{price}, #{mileage}, #{times}, #{starttime}, #{endtime}, #{counttimes}, #{timesubsidies}, #{mileageprices},
		#{reviewperson}, #{reason}, now(), #{operator}, now(), now(), '1', #{reviewstatus}, #{rawstarttime}, #{rawendtime}, #{rawtimes},
		#{rawmileage}, #{reviewedprice}, #{opinion}, #{raworderamount}, #{pricecopy}, #{rawpricecopy})
	</insert>
	
	<update id="updateOrderState"  parameterType="OrgOrder">
		update org_order set updateTime=now() 
		
		<if test="orderstatus != null">
			, orderstatus = #{orderstatus} 
		</if>
		
		<if test="reviewstatus != null">
			, reviewstatus = #{reviewstatus} 
		</if>
		
		<if test="paymentstatus != null">
			, paymentstatus = #{paymentstatus} 
		</if>
		
		<if test="orderreason != null">
			, orderreason = #{orderreason}
		</if>
		<if test="orderamount != null">
			, orderamount = #{orderamount}
		</if>
		<if test="mileage != null">
			, mileage = #{mileage}
		</if>
		<if test="starttime != null">
			, starttime = #{starttime}
		</if>
		<if test="endtime != null">
			, endtime = #{endtime}
		</if>
		<if test="pricecopy != null">
			, pricecopy = #{pricecopy}
		</if>
		<if test="shouldpayamount != null">
			, shouldpayamount = #{shouldpayamount}
		</if>
		<if test="actualpayamount != null">
			, actualpayamount = #{actualpayamount}
		</if>
		<if test="belongleasecompany != null">
			, belongleasecompany = #{belongleasecompany}
		</if>
		where orderno=#{orderno}
	</update>
	
	<update id="changeOrgDriver"  parameterType="map">
		update org_order set updateTime=#{updatetime}, driverid = #{newdriverid}, pricemodel = #{pricemodel}, ordertime = now(),
		factmodel = #{factmodel}, pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), orderstatus = "2", isusenow = #{isusenow}
		where orderno=#{orderno}
	</update>
	
	<!-- 申请复核 -->
	<update id="applyRecheckOrder" parameterType="map">
		update org_order set updateTime=now(),  orderreason = #{orderreason}, reviewperson = #{reviewperson}, reviewstatus = #{reviewstatus}
		where orderno=#{orderno}
	</update>
	
	<!-- 添加人工派单记录 -->
	<insert id="insertOrgSendrecord" parameterType="OrgSendrecord">
		insert into org_sendrecord(id, orderno, driverid, operator, chargemodel, reason, sendtime, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{driverid}, #{operator}, #{chargemodel}, #{reason}, now(), now(), now(), 1)
	</insert>
	
	<!-- 添加司机更换记录 -->
	<insert id="insertOrgDriverchanges" parameterType="OrgDriverchanges">
		insert into org_driverchanges(id, orderno, beforedriverid, afterdriverid, chargemodel, reason, sendtime, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{beforedriverid}, #{afterdriverid}, #{chargemodel}, #{reason}, #{sendtime}, #{operator}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 查询当前用户所在租赁公司的派单规则城市 -->
	<select id="getSendRulesByName" parameterType="PubSendRules" resultType="map">
		select pub_sendrules.city id, pub_cityaddr.city text
		from pub_sendrules, pub_cityaddr
		where pub_sendrules.city = pub_cityaddr.id
		and pub_sendrules.leasescompanyid = #{leasesCompanyId}
		and pub_sendrules.status = 1
		and pub_cityaddr.status = 1
        and pub_sendrules.platformtype = "1"
        and pub_sendrules.vehicletype = 0
		<if test='null != cityName and "" != cityName'>
			and pub_cityaddr.city like concat("%", #{cityName}, "%")
		</if>
	</select>
	
	<!-- 根据司机查询计费规则 -->
	<select id="findModelPriceByModels" parameterType="map" resultType="LeAccountRules">
		<if test="type == 1">
			select * from le_accountrules
			where leasescompanyid = #{leasescompanyid} 
			and city = #{city} 
			and cartype = #{cartype} 
			and rulestype = #{rulestype} 
			and type = '0' 
			and rulesstate = 0 
			and status = 1
			limit 1
		</if>
		<if test="type == 0">
			select le_accountrules.* from le_accountrules, le_company_rules_ref
			where le_company_rules_ref.organid in
			(select id from org_organ where creditcode = (select creditcode from org_organ where id = #{organid}))
			and le_company_rules_ref.leasescompanyid = #{leasescompanyid}
			and le_accountrules.city = #{city} 
			and le_accountrules.cartype = #{cartype} 
			and le_accountrules.rulestype = #{rulestype} 
			and le_accountrules.type = '1' 
			and le_accountrules.rulesstate = 0 
			and le_accountrules.status = 1
			and le_company_rules_ref.id = le_accountrules.rulesrefid
			and le_company_rules_ref.status = 1
			and le_company_rules_ref.rulestate = 1
			and now() &gt; le_company_rules_ref.starttime
			and now() &lt; le_company_rules_ref.endtime
			limit 1
		</if>
	</select>
	
	<!-- 添加退款记录 -->
	<insert id="insertOrgUserrefund" parameterType="OrgUserRefund">
		insert into org_userrefund(id, userid, leasescompanyid, orderno, committime, confirmtime, amount, refundstatus, remark, createtime, updatetime, creater, updater, status)
		values(#{id}, #{userId}, #{leasesCompanyId}, #{orderNo}, now(), now(), #{amount}, #{refundStatus}, #{remark}, now(), now(), #{creater}, #{updater}, #{status})
	</insert>
	
	<!-- 查询租赁公司-机构的关联信息 -->
	<select id="getOrgOrganCompanyRefByOrgCom" resultType="OrgOrganCompanyRef" parameterType="OrgOrganCompanyRef">
		select * from org_organ_company_ref where companyid = #{companyId} and status = 1 and organid in
		(select id from org_organ where creditcode in (select creditcode from org_organ where id = #{organId})) limit 1
	</select>
	
	<!-- 修改租赁公司-机构可用余额 -->
	<update id="updateOrgOrganCompanyRef" parameterType="OrgOrganCompanyRef">
		update org_organ_company_ref set balance = #{balance}, updatetime = now() where id = #{id}
	</update>
	
	<!-- 根据租赁公司和城市查询派单规则 -->
	<select id="getLeSendrulesList" resultType="PubSendRules" parameterType="PubSendRules">
		select * from pub_sendrules where leasescompanyid = #{leasescompanyid} and city = #{city} and status = 1
		  and platformtype = "1" and vehicletype = 0
	</select>
	
	<!-- 查询用户对应的机构权限 -->
	<select id="getOrganByName" parameterType="map" resultType="map">
		<choose>
			<!-- 普通 -->
		    <when test="specialstate != 1">
		        select
					org_organ.id, org_organ.shortname text
				from
					le_roledataauthority,
					le_roleuser,
					le_user,
					org_organ
				where
				le_roledataauthority.status=1
				and le_roleuser.status=1
				and le_user.status=1
				and le_user.id = le_roleuser.userid
				and le_roleuser.roleid = le_roledataauthority.roleid
				and le_roledataauthority.dynamicid = org_organ.id
				and le_user.account=#{account}
				and le_user.leasescompanyid = #{leasescompanyid}
				<if test='null != organName and "" != organName'>
					and org_organ.shortname like concat("%", #{organName}, "%")
				</if>
		    </when>
		    <otherwise>
		    	<!-- 超管 -->
				select
					org_organ.id, org_organ.shortname text
				from
					org_organ,
					org_organ_company_ref
				where
				org_organ.status=1
				and org_organ_company_ref.status=1
				and org_organ_company_ref.organid = org_organ.id
				and org_organ_company_ref.companyid = #{leasescompanyid}
				<if test='null != organName and "" != organName'>
					 and org_organ.shortname like concat("%", #{organName}, "%")
				</if>
		    </otherwise>
		</choose>
	</select>
	
	<!-- 修改司机状态 -->
	<update id="updatePubDriverWorkstatus" parameterType="PubDriver">
		update pub_driver set workstatus = #{workStatus} where id = #{id}
	</update>
	
	<!-- 查询最原始订单数据 -->
	<select id="getFirstOrderByOrderno" parameterType="string" resultType="map">
		select
		org_orderreview.*,
		ifnull((select reviewedprice from org_orderreview where orderno = #{orderno} and status = 1 order by createtime desc limit 1), 0) recheckprice,
		(select pricecopy from org_order where orderno = #{orderno}) pricecopy
		from org_orderreview where orderno = #{orderno} order by createtime asc limit 1
	</select>
	
	<!-- 添加司机消息 -->
	<insert id="insertPubDriverNews" parameterType="PubDriverNews">
		insert into pub_drivernews(id, driverid, type, title, content, newsstate, createtime, updatetime, status)
		values(#{id}, #{driverid}, #{type}, #{title}, #{content}, #{newsstate}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 根据订单号查询订单的车辆相关信息 -->
	<select id="getOrgOrderVehicleByOrder" resultType="map" parameterType="string">
		select
			(select le_vehiclemodels.name from le_vehiclemodels where org_order.factmodel = le_vehiclemodels.id) factmodelname,
			(select le_vehiclemodels.name from le_vehiclemodels where org_order.pricemodel = le_vehiclemodels.id) pricemodelname,
			pub_vehcbrand.name vehcbrandname, pub_vehcline.name vehclinename,
			concat((select text from pub_dictionary where type = '车牌省' and value = pub_vehicle.platenoprovince),
			(select text from pub_dictionary where type = '车牌市' and value = pub_vehicle.platenocity), pub_vehicle.plateno) plateno
		from
			org_order left join pub_vehicle on org_order.vehicleid = pub_vehicle.id
			left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
			left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
		where
			org_order.orderno = #{orderno}
	</select>
	
	<!-- 更新订单的车辆相关信息 -->
	<update id="updateOrgOrderVehicleByOrderno" parameterType="OrgOrder">
		update org_order set factmodelname = #{factmodelname}, pricemodelname = #{pricemodelname},
		vehcbrandname = #{vehcbrandname}, vehclinename = #{vehclinename}, plateno = #{plateno},
		belongleasecompany = #{belongleasecompany} 
		where orderno = #{orderno}
	</update>
	
	<!-- 查询客服备注列表 -->
	<select id="getOrgOrderCommentListByQuery" resultType="map" parameterType="OrdercommentQueryParam">
		select
			org_ordercomment.id, org_ordercomment.remark, org_ordercomment.operator, org_ordercomment.remarktype,
			date_format(org_ordercomment.createtime, '%Y.%m.%d %H:%i') createtime,
			le_rolemanagement.rolename, le_user.nickname, le_user.specialstate
		from
			org_ordercomment left join le_roleuser on org_ordercomment.operator = le_roleuser.userid
			left join le_rolemanagement on le_roleuser.roleid = le_rolemanagement.id
			left join le_user on org_ordercomment.operator = le_user.id
		where
			org_ordercomment.orderno = #{orderno} and org_ordercomment.status = 1
		order by org_ordercomment.createtime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgOrderCommentCountByQuery" resultType="int" parameterType="OrdercommentQueryParam">
		select
			count(*)
		from
			org_ordercomment
		where
			org_ordercomment.orderno = #{orderno} and org_ordercomment.status = 1
	</select>
	
	<!-- 添加客服备注 -->
	<select id="insertOrgOrdercomment" parameterType="OrgOrdercomment">
		insert into org_ordercomment(id, orderno, remarktype, remark, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{remarktype}, #{remark}, #{operator}, now(), now(), 1)
	</select>
	
	<!-- 订单号联想框(select2) -->
	<select id="getOrdernoBySelect" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno id, org_order.orderno text
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
			
			<if test='null != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='type == "1"'>
				and org_order.orderstatus = '1'
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "2"'>
				and org_order.orderstatus in ('2', '3', '4', '5', '6')
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "3"'>
				and org_order.reviewstatus = "1"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "4"'>
				and org_order.reviewstatus = "2"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and org_order.paymentstatus = "4"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
				</if>
			</if>
			
			<if test='type == "5"'>
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
				</if>
			</if>
			
			<if test='type == "6"'>
				and org_order.orderstatus = "7"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
				</if>
			</if>
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 查询最近一次的订单复核记录 -->
	<select id="getOrgOrderreviewLastByOrderno" parameterType="string" resultType="OrgOrderReview">
		select * from org_orderreview where orderno = #{orderno} order by createtime desc limit 1
	</select>
	
	<update id="orderReject" parameterType="OrgOrder">
		update org_order set updatetime = now(), reviewstatus = #{reviewstatus} where orderno = #{orderno}
	</update>

    <!-- 获取服务车企(select2) -->
    <select id="getBelongLeaseCompanySelect" resultType="map" parameterType="map">
        select id, `text` from pub_dictionary where type='租赁公司' and status = '1'
        <if test='null != shortname'>
            and text like concat('%', #{shortname}, '%')
        </if>
        order by text asc
    </select>

    <!-- 修改司机状态为空闲 -->
    <update id="updatePubDriverLeisure" parameterType="string">
        update pub_driver set workstatus = "0", updatetime = now() where id = #{driverid}
    </update>

</mapper>