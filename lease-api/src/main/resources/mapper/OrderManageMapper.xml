<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 引入接口，只要实现接口的方法就会调用对应接口方法的 select id -->
<mapper namespace="com.szyciov.lease.mapper.OrderManageMapper">
	<select id="getPubDriver" parameterType="String" resultType="PubDriver">
	SELECT * FROM pub_driver where status = 1 AND id = #{id}
	</select>
	<!-- 根据机构权限查询订单列表-->
	<sql id="getOrderListByOrganSQL">
		and org_order.organid in 
		(select org_organ.id from org_organ where org_organ.creditcode in 
			(<choose>
				<!-- 普通 -->
			    <when test="specialstate != 1">
			        select
						org_organ.creditcode
					from
						le_roledataauthority,
						le_roleuser,
						le_user,
						org_organ
					where
					le_roledataauthority.status = 1
					and le_roleuser.status = 1
					and le_user.status = 1
					and le_user.id = le_roleuser.userid
					and le_roleuser.roleid = le_roledataauthority.roleid
					and le_roledataauthority.dynamicid = org_organ.id
					and le_user.account = #{account}
					and le_user.leasescompanyid = #{leasescompanyid}
					<if test='null != organId and "" != organId'>
						and org_organ.id = #{organId}
					</if>
			     </when>
			     <otherwise>
			     	<!-- 超管 -->
					select
						org_organ.creditcode
					from
						org_organ,
						org_organ_company_ref
					where
					org_organ.status=1
					and org_organ_company_ref.status=1
					and org_organ_company_ref.organid = org_organ.id
					and org_organ_company_ref.companyid = #{leasescompanyid}
					<if test='null != organId and "" != organId'>
						and org_organ.id = #{organId}
					</if>
			     </otherwise>
			</choose>)
		)
	</sql>

	<!-- 待接订单列表查询 -->
	<select id="getOrgLabourOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.organid, org_order.usetype,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone,
            org_order.usetime, org_order.undertime, org_order.pushnumber, org_order.orderstatus, org_user.status userstatus,
            getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
            getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ("0", "1")
            and org_order.usetype = #{usetype}

			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.undertime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.undertime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>
			
			<include refid="getOrderListByOrganSQL"></include>
		order by
			org_order.createtime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgLabourOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ("0", "1")
            and org_order.usetype = #{usetype}
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.undertime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.undertime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 当前订单列表查询 -->
	<select id="getOrgCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.organid, org_order.usetype,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
            getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
            getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress,
            org_order.usetime, org_order.updatetime, org_order.belongleasecompany, org_user.status userstatus, org_order.companyid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
            and org_order.usetype = #{usetype}

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>
			
			<include refid="getOrderListByOrganSQL"></include>
		order by
			org_order.orderstatus asc, 
			case when org_order.orderstatus = '2' then org_order.usetime else '' end asc,
			case when org_order.orderstatus != '2' then org_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.orderstatus in ('2', '3', '4', '5', '6')
            and org_order.usetype = #{usetype}

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderstatus and "" != orderstatus'>
				and org_order.orderstatus = #{orderstatus}
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>
			
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 待复核订单列表查询 -->
	<select id="getOrgAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.paytype,
            org_order.reviewperson, org_order.organid, org_order.actualpayamount, org_order.paymethod, org_order.orderamount,
            org_order.mileage, org_order.pricecopy, org_order.starttime, org_order.endtime, org_order.usetime, org_order.companyid,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
            getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
            getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress,
            org_order.plateno, org_order.shouldpayamount, ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.times reviewtimes,
            tmp.counttimes reviewcounttimes, tmp.id reviewid, org_order.belongleasecompany, org_user.status userstatus,
            (select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
            (select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = org_order.orderno) actualamount
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
            and org_order.usetype = #{usetype}

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>
			
			<if test='null != paymentstatus and "" != paymentstatus'>
				and org_order.paymentstatus = #{paymentstatus}
			</if>
			
			<if test='null != driverid and "" != driverid'>
				and org_order.driverid = #{driverid}
			</if>
			
			<if test='null != userId and "" != userId'>
				and org_order.userid = #{userId}
			</if>
			
			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

			<if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
			</if>
			
			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>
			
			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.updatetime asc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "1"
            and org_order.usetype = #{usetype}

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and org_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 已复核订单列表查询 -->
	<select id="getOrgWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.reviewperson, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.paymethod, org_order.companyid, org_order.belongleasecompany,
            org_order.originalorderamount, org_order.shouldpayamount, org_order.actualpayamount, org_order.starttime, org_order.endtime,
			org_order.originalorderamount, tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes,
            tmp.times reviewtimes, tmp.id reviewid, tmp.rawpricecopy, tmp.reviewtype, org_user.status userstatus, org_order.pricecopy,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = org_order.orderno) actualamount
		from
			org_order left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join org_user on org_order.userid = org_user.id
        where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
            and org_order.usetype = #{usetype}
            <if test='usetype == "0"'>
				and org_order.paymentstatus in ("4", "9")
			</if>
			<if test='usetype == "1"'>
				and org_order.paymentstatus in ("0", "1", "9")
			</if>
			
			<if test='null != orderNo and "" != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='null != orderType and "" != orderType'>
				and org_order.ordertype = #{orderType}
			</if>

			<if test='null != reviewperson and "" != reviewperson'>
				and org_order.reviewperson = #{reviewperson}
			</if>

			<if test='null != ordersource and "" != ordersource'>
				and org_order.orderno like concat(#{ordersource}, '%')
			</if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.updatetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_user on org_order.userid = org_user.id
		where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.reviewstatus = "2"
            and org_order.usetype = #{usetype}
            <if test='usetype == "0"'>
                and org_order.paymentstatus in ("4", "9")
            </if>
            <if test='usetype == "1"'>
                and org_order.paymentstatus in ("0", "1", "9")
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and org_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>
	</select>

    <!-- 待收款订单列表查询 -->
    <select id="getOrgWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
        select
            org_order.orderno, org_order.ordertype, org_order.paymentstatus, org_order.orderstatus, org_order.organid, org_order.paytype,
            (select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
            org_order.orderamount, org_order.mileage, org_order.pricecopy, org_order.expensetype, org_order.starttime, org_order.endtime,
            org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
            (select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = org_order.driverid) drivername,
            org_order.usetime, org_order.reviewstatus, org_order.paymethod, org_order.plateno, org_order.shouldpayamount,
            org_order.companyid, org_order.belongleasecompany, org_order.status userstatus, org_ordercancel.cancelamount,
            getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
            getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress,
            ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname
        from
            org_order left join org_user on org_order.userid = org_user.id
            left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
            left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
        where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype}
            and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))
            <if test='usetype == "0"'>
                and org_order.paymentstatus in ("0", "2", "4")
            </if>
            <if test='usetype == "1"'>
                and org_order.paymentstatus = "0"
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and org_order.expensetype = #{expensetype}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>

        order by
          org_order.paymentstatus desc, org_order.usetime desc
        limit #{iDisplayStart}, #{iDisplayLength}
    </select>
    <select id="getOrgWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
        select
          count(*)
        from
          org_order left join org_user on org_order.userid = org_user.id
          left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
        where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype}
            and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))
            <if test='usetype == "0"'>
                and org_order.paymentstatus in ("0", "2", "4")
            </if>
            <if test='usetype == "1"'>
                and org_order.paymentstatus = "0"
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and org_order.expensetype = #{expensetype}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>
    </select>

	<!-- 已完成订单列表查询 -->
	<select id="getOrgCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno, org_order.ordertype, org_order.orderstatus, org_order.paymentstatus, org_order.paytype, org_order.organid,
			(select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
			org_order.orderamount, org_order.mileage, org_order.pricecopy, org_order.factmodelname, org_user.status userstatus,
            org_order.starttime, org_order.endtime, org_order.usetime, org_order.undertime, org_order.ordertime,
			org_user.id, org_user.nickname, org_user.account, org_order.passengers, org_order.passengerphone, org_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername,
            getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
            getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress,
			org_order.cancelparty, org_order.reviewstatus, org_order.paymethod, org_order.expensetype, org_orderpaymentrecord.tradeno,
			org_order.factmodelname, org_order.shouldpayamount, org_order.actualpayamount, org_ordercancel.cancelamount, org_order.companyid,
            pub_driver.jobnum, org_order.plateno, org_order.estimatedtime, org_order.estimatedmileage, org_order.belongleasecompany,
			ifnull(tmp.mileage, org_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = org_order.orderno) actualamount
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp on org_order.orderno = tmp.orderno
			left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
			left join pub_driver on org_order.driverid = pub_driver.id
            left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype}
            and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))

            <if test='usetype == "0"'>
                and org_order.paymentstatus in ("1", "3", "9")
            </if>
            <if test='usetype == "1"'>
                and org_order.paymentstatus in ("1", "9")
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paytype and "" != paytype'>
                and org_order.paytype = #{paytype}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and org_order.expensetype = #{expensetype}
            </if>

            <if test='null != paymethod and "" != paymethod'>
                and org_order.paymethod = #{paymethod}
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

			<include refid="getOrderListByOrganSQL"></include>
			
			order by
				org_order.orderstatus, org_order.usetime desc
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			org_order left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
            left join org_user on org_order.userid = org_user.id
            left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
        where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype}
            and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))

            <if test='usetype == "0"'>
                and org_order.paymentstatus in ("1", "3", "9")
            </if>
            <if test='usetype == "1"'>
                and org_order.paymentstatus in ("1", "9")
            </if>

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paytype and "" != paytype'>
                and org_order.paytype = #{paytype}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and org_order.expensetype = #{expensetype}
            </if>

            <if test='null != paymethod and "" != paymethod'>
                and org_order.paymethod = #{paymethod}
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>
	</select>

    <!-- 已取消订单列表查询 -->
    <select id="getOrgCancelOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
        select
          org_order.orderno, org_order.paymentstatus, org_order.ordertype, org_order.cancelparty, org_order.canceltime,
          org_order.paytype, org_order.paymethod, org_order.userid, org_user.nickname, org_user.account,org_order.passengers,
          org_order.passengerphone, org_order.driverid, org_order.organid, org_order.companyid, org_order.belongleasecompany,
          org_ordercancel.cancelnature, org_ordercancel.dutyparty, org_ordercancel.cancelamount, org_ordercancel.cancelreason,
          org_ordercancel.exemption, org_orderpaymentrecord.tradeno, org_user.status userstatus, org_order.usetime,
          (select le_user.nickname from le_user where le_user.id = org_ordercancel.canceloperator) cancelname,
          (select le_user.nickname from le_user where le_user.id = org_ordercancel.exemptionoperator) exemptionname,
          concat(pub_driver.name, " ", pub_driver.phone) drivername,
          (select org_organ.shortname from org_organ where org_organ.id = org_order.organid) organname,
          getCityStr(org_order.oncity) oncityname, org_order.oncity, org_order.onaddress,
          getCityStr(org_order.offcity) offcityname, org_order.offcity, org_order.offaddress,
          (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongcompanyname
        from
          org_order left join org_user on org_order.userid = org_user.id
          left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
          left join pub_driver on org_order.driverid = pub_driver.id
          left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
        where
          org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype} and org_order.orderstatus = "8"

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>
    
            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "10" == paymentstatus'>
                and org_ordercancel.cancelnature = 2
            </if>
            <if test='null != paymentstatus and "" != paymentstatus and "10" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus} and org_ordercancel.cancelnature = 1
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != paymethod and "" != paymethod'>
                and org_order.paymethod = #{paymethod}
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != cancelparty and "1" == cancelparty'>
                and org_order.cancelparty in ("2", "3")
            </if>
            <if test='null != cancelparty and "" != cancelparty and "1" != cancelparty'>
                and org_order.cancelparty = #{cancelparty}
            </if>

            <if test='null != cancelnature'>
                and org_ordercancel.cancelnature = #{cancelnature}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>

        order by
          org_order.usetime desc
        limit #{iDisplayStart}, #{iDisplayLength}
    </select>
    <select id="getOrgCancelOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
        select
          count(*)
        from
            org_order left join org_user on org_order.userid = org_user.id
            left join org_orderpaymentrecord on org_order.orderno = org_orderpaymentrecord.orderno and not isnull(org_orderpaymentrecord.tradeno)
            left join pub_driver on org_order.driverid = pub_driver.id
            left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
        where
            org_order.status = 1 and org_order.companyid = #{leasescompanyid} and org_order.usetype = #{usetype} and org_order.orderstatus = "8"

            <if test='null != ordersource and "" != ordersource'>
                and org_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != ordernature and "0" == ordernature'>
                and org_order.companyid = org_order.belongleasecompany
            </if>
            <if test='null != ordernature and "1" == ordernature'>
                and org_order.companyid != org_order.belongleasecompany
            </if>

            <if test='null != orderType and "" != orderType'>
                and org_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and org_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != driverid and "" != driverid'>
                and org_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and org_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "10" == paymentstatus'>
                and org_ordercancel.cancelnature = 2
            </if>
            <if test='null != paymentstatus and "" != paymentstatus and "10" != paymentstatus'>
                and org_order.paymentstatus = #{paymentstatus} and org_ordercancel.cancelnature = 1
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and org_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != paymethod and "" != paymethod'>
                and org_order.paymethod = #{paymethod}
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and org_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != cancelparty and "1" == cancelparty'>
                and org_order.cancelparty in ("2", "3")
            </if>
            <if test='null != cancelparty and "" != cancelparty and "1" != cancelparty'>
                and org_order.cancelparty = #{cancelparty}
            </if>

            <if test='null != cancelnature'>
                and org_ordercancel.cancelnature = #{cancelnature}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and org_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and org_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>

            <if test='null != organId and "" != organId'>
                and org_user.status = 1
            </if>

            <include refid="getOrderListByOrganSQL"></include>
    </select>
	
	<select id="getOrgOrderByOrderno" resultType="map" parameterType="String">
		select 
			org_order.*, org_user.nickname, org_user.account, pub_driver.name drivername, pub_driver.phone driverphone,
			pub_dictionary.value vehiclessubjectvalue, getCityStr(org_order.oncity) oncityName, getCityStr(org_order.offcity) offcityName,
			ifnull(tmp.price, 0) price, tmp.starttime reviewstarttime, tmp.endtime reviewendtime, tmp.times reviewtimes,
			tmp.counttimes reviewcounttimes, tmp.mileage reviewmileage, tmp.timesubsidies reviewtimesubsidies, tmp.mileageprices reviewmileageprices,
			tmp.reviewtype, org_ordercancel.cancelnature, org_ordercancel.cancelamount, tmp.pricecopy reviewpricecopy, pub_coupon_use.actualamount,
			(select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = org_order.belongleasecompany) belongleasecompanytext
		from
			org_order left join org_user on org_order.userid = org_user.id
			left join (select * from (select * from org_orderreview order by createtime desc) review group by orderno) tmp
				on org_order.orderno = tmp.orderno
			left join pub_driver on org_order.driverid = pub_driver.id
			left join pub_dictionary on org_order.vehiclessubjecttype = pub_dictionary.id
			left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
			left join pub_coupon_use on org_order.orderno = pub_coupon_use.billingorderid and pub_coupon_use.usestate = 1 and pub_coupon_use.usetype = 2
		where
		  org_order.status = 1 and org_order.orderno = #{orderno}
		limit 1
	</select>
	
	<select id="getOrgOrder" resultType="OrgOrder" parameterType="String">
		select * from org_order where status = 1 and orderno = #{orderno}
	</select>
	
	<select id="getOrgUser" parameterType="map" resultType="map">
		select id, if(isnull(nickname) || nickname = '', account, concat(nickname, " ", account)) text from org_user
		where organid in 
		(
			select id from org_organ 
			where creditcode in 
				(
					select creditcode from org_organ where id in 
						(select organid from org_organ_company_ref where companyid = #{leasescompanyid} and status = 1)
				)
			and status = 1
			<if test="organId != null and organId != ''">
				and creditcode = (select creditcode from org_organ where id = #{organId} and status = 1)
			</if>
		)
		and status = 1 and usertype = '0'
		<if test="userName != null and userName != ''">
			and (nickname like "%"#{userName}"%" or account like "%"#{userName}"%")
		</if>
	</select>
	
	<sql id="getVehicleModelRulesSQL">
		from
			le_accountrules left join le_company_rules_ref on le_accountrules.rulesrefid = le_company_rules_ref.id
			left join le_vehiclemodels on le_accountrules.cartype = le_vehiclemodels.id
		where
			le_accountrules.status = 1 and le_company_rules_ref.status = 1 and le_vehiclemodels.status = 1
			and le_accountrules.leasescompanyid = #{leasescompanyid} and le_accountrules.city = #{oncity}
			and le_accountrules.rulestype = #{orderType} and le_accountrules.rulesstate = "0"
			and le_company_rules_ref.leasescompanyid = #{leasescompanyid} and le_company_rules_ref.organid = #{organId}
			and le_company_rules_ref.rulestate = "1" and le_vehiclemodels.modelstatus = "0"
			and le_vehiclemodels.leasescompanyid = #{leasescompanyid} and le_accountrules.type = "1"
			group by le_vehiclemodels.id
	</sql>
	<sql id="getVehicleModelSQL">
		from
			le_accountrules left join le_vehiclemodels on le_accountrules.cartype = le_vehiclemodels.id
		where
			le_accountrules.status = 1 and le_vehiclemodels.status = 1
			and le_accountrules.leasescompanyid = #{leasescompanyid} and le_accountrules.city = #{oncity}
			and le_accountrules.rulestype = #{orderType} and le_accountrules.rulesstate = "0"
			and le_vehiclemodels.modelstatus = "0" and le_vehiclemodels.leasescompanyid = #{leasescompanyid}
			 and le_accountrules.type = "0"
			group by le_vehiclemodels.id
	</sql>
	<select id="getCompanyVehicleModel" parameterType="map" resultType="map">
		<if test='null != usetype and usetype == "0"'>
			select
				le_vehiclemodels.id, le_vehiclemodels.name text
			<include refid="getVehicleModelRulesSQL"></include>
		</if>
		<if test='null != usetype and usetype == "1"'>
			select
				le_vehiclemodels.id, le_vehiclemodels.name text
			<include refid="getVehicleModelSQL"></include>
		</if>
	</select>
	
	<select id="getOrgWaitingOrderByOrderno" resultType="map" parameterType="String">
		SELECT
			a.*, b.nickname,
			b.account,
			c.`name` vehiclemodelname,
			(select text from pub_dictionary t1 where t1.id = a.oncity and t1.`status` = 1) oncityname,
			(select text from pub_dictionary t1 where t1.id = a.offcity and t1.`status` = 1) offcityname
		FROM
			org_order a,
			org_user b,
			le_vehiclemodels c
		WHERE
			a.userid = b.id
		AND a.selectedmodel = c.Id
		AND a.`status` = 1
		AND b.`Status` = 1
		AND c.`Status` = 1
		AND a.orderno = #{orderno} limit 1
	</select>
	
	<select id="getOrgDriverByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
            pub_driver.id driverid, pub_driver.name drivername, pub_driver.workstatus, pub_driver.lat, pub_driver.lng, pub_driver.phone,
            pub_driver.headportraitmin, pub_driver.headportraitmax, concat(pub_vehcbrand.name, '.', pub_vehcline.name) brandname, le_vehiclemodels.name modelname,
            getPlatenoStr(pub_vehicle.platenoprovince, pub_vehicle.platenocity, pub_vehicle.plateno) plateno,
            le_vehiclemodels.id modelsid, pub_vehicle.id vehicleid
        from
            pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
            left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
            left join pub_vehicle_models_ref on pub_vehicle.id = pub_vehicle_models_ref.vehicleid
            left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
            left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.Id
            left join le_vehiclemodels on pub_vehicle_models_ref.vehiclemodelsid = le_vehiclemodels.Id
            left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
        where
            pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1
            and pub_vehcline.status = 1 and le_vehiclemodels.status = 1
            and pub_vehicle_scope.status = 1 and pub_driver.workstatus in ("0", "1", "2")
            and pub_vehicle_models_ref.companyid = #{leasescompanyid}
            and pub_driver.phone not in (select org_user.account from org_user where org_user.id = #{userId} and org_user.status = 1)
            and pub_driver.vehicletype = "0" and pub_driver.platformtype = "1"
            and pub_driver.phone not in (select account from org_user where org_user.id = #{userId} and org_user.status = 1)
            <if test='null != isusenow and isusenow == 1'>
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6'))
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and org_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                ]]>)

                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6'))
                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and op_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                ]]>)
            </if>
            <if test='null != isusenow and isusenow == 0'>
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_add(org_order.usetime, interval (1) hour) <= #{usetime}
                ]]>)
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_format(org_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                ]]>)

                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_add(op_order.usetime, interval (1) hour) <= #{usetime}
                ]]>)
                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_format(op_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                ]]>)
            </if>

            and le_vehiclemodels.id in (
            <if test='null != usetype and usetype == "0"'>
                select
                le_vehiclemodels.id
                <include refid="getVehicleModelRulesSQL"></include>
            </if>
            <if test='null != usetype and usetype == "1"'>
                select
                le_vehiclemodels.id
                <include refid="getVehicleModelSQL"></include>
            </if>
            )
            <if test="driverid != null and driverid != ''">
                and pub_driver.id != #{driverid}
            </if>
            <if test="selectdriverid != null and selectdriverid != ''">
                and pub_driver.id = #{selectdriverid}
            </if>

            <if test="oncity != null and oncity != ''">
                and (pub_vehicle_scope.cityid = #{oncity}
                <if test="offcity != null and offcity != ''">
                    or pub_vehicle_scope.cityid = #{offcity}
                </if>
                )
            </if>
            <if test="driverState != null and driverState != ''">
                and pub_driver.workstatus = #{driverState}
            </if>
            <if test="selectedmodel != null and selectedmodel != ''">
                and le_vehiclemodels.id = #{selectedmodel}
            </if>
            <if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
                <![CDATA[
                    and pub_driver.lat >= ${minLat} and pub_driver.lat <= ${maxLat}
                ]]>
            </if>
            <if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
                <![CDATA[
                    and pub_driver.lng >= ${minLon} and pub_driver.lng <= ${maxLon}
                ]]>
            </if>
            <if test="driverName != null and driverName != ''">
                and pub_driver.name like concat("%", #{driverName}, "%")
            </if>
            <if test="models == 1">
                and le_vehiclemodels.level >= (select level from le_vehiclemodels where id = #{orderSelectedmodel})
            </if>
            <if test="models == 0">
                and le_vehiclemodels.id = #{orderSelectedmodel}
            </if>
            <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
                and pub_driver.belongleasecompany = #{queryTmpBelongleasecompany}
            </if>
            and pub_driver.lng &gt; 0 and pub_driver.lat &gt; 0
        group by pub_driver.id
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	
	<select id="getOrgDriverCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
          count(*)
		from 
            (select
                pub_driver.id driverid
            from
                pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
                left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
                left join pub_vehicle_models_ref on pub_vehicle.id = pub_vehicle_models_ref.vehicleid
                left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
                left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.Id
                left join le_vehiclemodels on pub_vehicle_models_ref.vehiclemodelsid = le_vehiclemodels.Id
                left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
            where
                pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1
                and pub_vehcline.status = 1 and le_vehiclemodels.status = 1
                and pub_vehicle_scope.status = 1 and pub_driver.workstatus in ("0", "1", "2")
                and pub_vehicle_models_ref.companyid = #{leasescompanyid}
                and pub_driver.phone not in (select org_user.account from org_user where org_user.id = #{userId} and org_user.status = 1)
                and pub_driver.vehicletype = "0" and pub_driver.platformtype = "1"
                and pub_driver.phone not in (select account from org_user where org_user.id = #{userId} and org_user.status = 1)
                <if test='null != isusenow and isusenow == 1'>
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6'))
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and org_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                    ]]>)

                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6'))
                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and op_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                    ]]>)
                </if>
                <if test='null != isusenow and isusenow == 0'>
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_add(org_order.usetime, interval (1) hour) <= #{usetime}
                    ]]>)
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_format(org_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                    ]]>)

                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_add(op_order.usetime, interval (1) hour) <= #{usetime}
                    ]]>)
                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_format(op_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                    ]]>)
                </if>

                and le_vehiclemodels.id in (
                <if test='null != usetype and usetype == "0"'>
                    select
                    le_vehiclemodels.id
                    <include refid="getVehicleModelRulesSQL"></include>
                </if>
                <if test='null != usetype and usetype == "1"'>
                    select
                    le_vehiclemodels.id
                    <include refid="getVehicleModelSQL"></include>
                </if>
                )
                <if test="driverid != null and driverid != ''">
                    and pub_driver.id != #{driverid}
                </if>
                <if test="selectdriverid != null and selectdriverid != ''">
                    and pub_driver.id = #{selectdriverid}
                </if>

                <if test="oncity != null and oncity != ''">
                    and (pub_vehicle_scope.cityid = #{oncity}
                    <if test="offcity != null and offcity != ''">
                        or pub_vehicle_scope.cityid = #{offcity}
                    </if>
                    )
                </if>
                <if test="driverState != null and driverState != ''">
                    and pub_driver.workstatus = #{driverState}
                </if>
                <if test="selectedmodel != null and selectedmodel != ''">
                    and le_vehiclemodels.id = #{selectedmodel}
                </if>
                <if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
                    <![CDATA[
                        and pub_driver.lat >= ${minLat} and pub_driver.lat <= ${maxLat}
                    ]]>
                </if>
                <if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
                    <![CDATA[
                        and pub_driver.lng >= ${minLon} and pub_driver.lng <= ${maxLon}
                    ]]>
                </if>
                <if test="driverName != null and driverName != ''">
                    and pub_driver.name like concat("%", #{driverName}, "%")
                </if>
                <if test="models == 1">
                    and le_vehiclemodels.level >= (select level from le_vehiclemodels where id = #{orderSelectedmodel})
                </if>
                <if test="models == 0">
                    and le_vehiclemodels.id = #{orderSelectedmodel}
                </if>
                <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
                    and pub_driver.belongleasecompany = #{queryTmpBelongleasecompany}
                </if>
                and pub_driver.lng &gt; 0 and pub_driver.lat &gt; 0
            group by pub_driver.id) tmp
	</select>
	
	<update id="manualSendOrder"  parameterType="map">
		update org_order set driverid=#{driverid}, orderstatus='2', pricemodel = #{pricemodel}, factmodel = #{factmodel}, pricecopy = #{pricecopy},
		vehicleid = #{vehicleid}, updatetime = now(), ordertime = now() where orderno=#{orderno}
	</update>
	
	<update id="cancelOrgOrder"  parameterType="String">
		update org_order set orderstatus='8', cancelparty='0', updatetime=now(), canceltime=now(), ordertime = now() where orderno=#{orderno}
	</update>
	
	<select id="getOrgSendOrderRecord" resultType="map" parameterType="String">
		select id, orderno, driverid, reason, operator, date_format(createtime, '%Y-%m-%d %H:%i') createtime, updatetime, status, 
		(select t1.nickname from le_user t1 where t.operator = t1.id) operatorname,
		(select CONCAT(t1.`name`,' ', t1.phone) from pub_driver t1 where t.driverid = t1.id) driverinfo
		from org_sendrecord t
		where orderno = #{orderno} and status = 1 limit 1
	</select>
	
	<select id="getOrgChangeDriverListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*,
		(select CONCAT(t1.`name`, ' ', t1.phone) from pub_driver t1 where t1.id = t.beforedriverid) beforedriverinfo,  
		(select CONCAT(t1.`name`, ' ', t1.phone) from pub_driver t1 where t1.id = t.afterdriverid) afterdriverinfo,
		(select t1.nickname from le_user t1 where t.operator = t1.id and t1.`status` = 1) operatorname,
		date_format(t.sendtime, '%Y/%m/%d %H:%i') changetime
		from org_driverchanges t, (select @rownum :=0) b
		where orderno = #{orderNo} and status = 1 order by createtime desc
	</select>
	
	<select id="getOrgChangeDriverListCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from org_driverchanges where orderno = #{orderNo} and status = 1
	</select>
	
	<select id="getOrgOrderReviewListRecord" resultType="map" parameterType="OrderManageQueryParam">
        select
            (@rownum := @rownum + 1) rownum,
            org_orderreview.*,
            (select le_user.nickname from le_user where le_user.id = org_orderreview.operator) operatorname
		from
          org_orderreview, (select @rownum :=0) b
        where
          org_orderreview.orderno = #{orderNo} and org_orderreview.status = 1
		order by org_orderreview.reviewtime desc
	</select>
	
	<select id="getOrgOrderReviewListCountRecord" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from org_orderreview where orderno = #{orderNo} and status = 1
	</select>
	
	<insert id="applyOrgOrderReview" parameterType="OrgOrderReview">
		insert into org_orderreview
		(id, orderno, price, mileage, times, starttime, endtime, counttimes, timesubsidies, mileageprices, reviewperson, reason, reviewtime,
		operator, createtime, updatetime, status, reviewstatus, rawstarttime, rawendtime, rawtimes, rawmileage, reviewedprice, opinion, raworderamount,
		pricecopy, rawpricecopy, reviewtype)
		values
		(#{id}, #{orderno}, #{price}, #{mileage}, #{times}, #{starttime}, #{endtime}, #{counttimes}, #{timesubsidies}, #{mileageprices},
		#{reviewperson}, #{reason}, now(), #{operator}, now(), now(), '1', #{reviewstatus}, #{rawstarttime}, #{rawendtime}, #{rawtimes},
		#{rawmileage}, #{reviewedprice}, #{opinion}, #{raworderamount}, #{pricecopy}, #{rawpricecopy}, #{reviewtype})
	</insert>
	
	<update id="updateOrderState"  parameterType="OrgOrder">
		update org_order set updateTime=now() 
		
		<if test="orderstatus != null">
			, orderstatus = #{orderstatus} 
		</if>
		
		<if test="reviewstatus != null">
			, reviewstatus = #{reviewstatus} 
		</if>
		
		<if test="paymentstatus != null">
			, paymentstatus = #{paymentstatus} 
		</if>
		
		<if test="orderreason != null">
			, orderreason = #{orderreason}
		</if>
		<if test="orderamount != null">
			, orderamount = #{orderamount}
		</if>
		<if test="mileage != null">
			, mileage = #{mileage}
		</if>
		<if test="starttime != null">
			, starttime = #{starttime}
		</if>
		<if test="endtime != null">
			, endtime = #{endtime}
		</if>
		<if test="pricecopy != null">
			, pricecopy = #{pricecopy}
		</if>
		<if test="shouldpayamount != null">
			, shouldpayamount = #{shouldpayamount}
		</if>
		<if test="actualpayamount != null">
			, actualpayamount = #{actualpayamount}
		</if>
		<if test="belongleasecompany != null">
			, belongleasecompany = #{belongleasecompany}
		</if>
		where orderno=#{orderno}
	</update>
	
	<update id="changeOrgDriver"  parameterType="map">
		update org_order set updateTime=#{updatetime}, driverid = #{newdriverid}, pricemodel = #{pricemodel}, ordertime = now(),
		factmodel = #{factmodel}, pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), orderstatus = "2"
		where orderno=#{orderno}
	</update>
	
	<!-- 申请复核 -->
	<update id="applyRecheckOrder" parameterType="map">
		update org_order set updateTime=now(),  orderreason = #{orderreason}, reviewperson = #{reviewperson}, reviewstatus = #{reviewstatus}
		where orderno=#{orderno}
	</update>
	
	<!-- 添加人工派单记录 -->
	<insert id="insertOrgSendrecord" parameterType="OrgSendrecord">
		insert into org_sendrecord(id, orderno, driverid, operator, chargemodel, reason, sendtime, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{driverid}, #{operator}, #{chargemodel}, #{reason}, now(), now(), now(), 1)
	</insert>
	
	<!-- 添加司机更换记录 -->
	<insert id="insertOrgDriverchanges" parameterType="OrgDriverchanges">
		insert into org_driverchanges(id, orderno, beforedriverid, afterdriverid, chargemodel, reason, sendtime, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{beforedriverid}, #{afterdriverid}, #{chargemodel}, #{reason}, #{sendtime}, #{operator}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 查询当前用户所在租赁公司的派单规则城市 -->
	<select id="getSendRulesByName" parameterType="PubSendRules" resultType="map">
		select pub_sendrules.city id, pub_cityaddr.city text
		from pub_sendrules, pub_cityaddr
		where pub_sendrules.city = pub_cityaddr.id
		and pub_sendrules.leasescompanyid = #{leasesCompanyId}
		and pub_sendrules.status = 1
		and pub_cityaddr.status = 1
        and pub_sendrules.platformtype = "1"
        and pub_sendrules.vehicletype = 0
		<if test='null != cityName and "" != cityName'>
			and pub_cityaddr.city like concat("%", #{cityName}, "%")
		</if>
	</select>
	
	<!-- 根据司机查询计费规则 -->
	<select id="findModelPriceByModels" parameterType="map" resultType="LeAccountRules">
		<if test="type == 1">
			select * from le_accountrules
			where leasescompanyid = #{leasescompanyid} 
			and city = #{city} 
			and cartype = #{cartype} 
			and rulestype = #{rulestype} 
			and type = '0' 
			and rulesstate = 0 
			and status = 1
			limit 1
		</if>
		<if test="type == 0">
			select le_accountrules.* from le_accountrules, le_company_rules_ref
			where le_company_rules_ref.organid in
			(select id from org_organ where creditcode = (select creditcode from org_organ where id = #{organid}))
			and le_company_rules_ref.leasescompanyid = #{leasescompanyid}
			and le_accountrules.city = #{city} 
			and le_accountrules.cartype = #{cartype} 
			and le_accountrules.rulestype = #{rulestype} 
			and le_accountrules.type = '1' 
			and le_accountrules.rulesstate = 0 
			and le_accountrules.status = 1
			and le_company_rules_ref.id = le_accountrules.rulesrefid
			and le_company_rules_ref.status = 1
			and le_company_rules_ref.rulestate = 1
			and now() &gt; le_company_rules_ref.starttime
			and now() &lt; le_company_rules_ref.endtime
			limit 1
		</if>
	</select>
	
	<!-- 添加退款记录 -->
	<insert id="insertOrgUserrefund" parameterType="OrgUserRefund">
		insert into org_userrefund(id, userid, leasescompanyid, orderno, committime, confirmtime, amount, refundstatus, remark, createtime, updatetime, creater, updater, status)
		values(#{id}, #{userId}, #{leasesCompanyId}, #{orderNo}, now(), now(), #{amount}, #{refundStatus}, #{remark}, now(), now(), #{creater}, #{updater}, #{status})
	</insert>
	
	<!-- 查询租赁公司-机构的关联信息 -->
	<select id="getOrgOrganCompanyRefByOrgCom" resultType="OrgOrganCompanyRef" parameterType="OrgOrganCompanyRef">
		select * from org_organ_company_ref where companyid = #{companyId} and status = 1 and organid in
		(select id from org_organ where creditcode in (select creditcode from org_organ where id = #{organId})) limit 1
	</select>
	
	<!-- 修改租赁公司-机构可用余额 -->
	<update id="updateOrgOrganCompanyRef" parameterType="OrgOrganCompanyRef">
		update org_organ_company_ref set balance = #{balance}, updatetime = now() where id = #{id}
	</update>
	
	<!-- 根据租赁公司和城市查询派单规则 -->
	<select id="getLeSendrulesList" resultType="PubSendRules" parameterType="PubSendRules">
		select * from pub_sendrules where leasescompanyid = #{leasescompanyid} and city = #{city} and status = 1
		  and platformtype = "1" and vehicletype = 0
	</select>
	
	<!-- 查询用户对应的机构权限 -->
	<select id="getOrganByName" parameterType="map" resultType="map">
		<choose>
			<!-- 普通 -->
		    <when test="specialstate != 1">
		        select
					org_organ.id, org_organ.shortname text
				from
					le_roledataauthority,
					le_roleuser,
					le_user,
					org_organ
				where
				le_roledataauthority.status=1
				and le_roleuser.status=1
				and le_user.status=1
				and le_user.id = le_roleuser.userid
				and le_roleuser.roleid = le_roledataauthority.roleid
				and le_roledataauthority.dynamicid = org_organ.id
				and le_user.account=#{account}
				and le_user.leasescompanyid = #{leasescompanyid}
				<if test='null != organName and "" != organName'>
					and org_organ.shortname like concat("%", #{organName}, "%")
				</if>
		    </when>
		    <otherwise>
		    	<!-- 超管 -->
				select
					org_organ.id, org_organ.shortname text
				from
					org_organ,
					org_organ_company_ref
				where
				org_organ.status=1
				and org_organ_company_ref.status=1
				and org_organ_company_ref.organid = org_organ.id
				and org_organ_company_ref.companyid = #{leasescompanyid}
				<if test='null != organName and "" != organName'>
					 and org_organ.shortname like concat("%", #{organName}, "%")
				</if>
		    </otherwise>
		</choose>
	</select>
	
	<!-- 修改司机状态 -->
	<update id="updatePubDriverWorkstatus" parameterType="PubDriver">
		update pub_driver set workstatus = #{workStatus} where id = #{id}
	</update>
	
	<!-- 查询最原始订单数据 -->
	<select id="getFirstOrderByOrderno" parameterType="string" resultType="map">
		select
		org_orderreview.*,
		ifnull((select reviewedprice from org_orderreview where orderno = #{orderno} and status = 1 order by createtime desc limit 1), 0) recheckprice,
		(select pricecopy from org_order where orderno = #{orderno}) pricecopy
		from org_orderreview where orderno = #{orderno} order by createtime asc limit 1
	</select>
	
	<!-- 添加司机消息 -->
	<insert id="insertPubDriverNews" parameterType="PubDriverNews">
		insert into pub_drivernews(id, driverid, type, title, content, newsstate, createtime, updatetime, status)
		values(#{id}, #{driverid}, #{type}, #{title}, #{content}, #{newsstate}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 根据订单号查询订单的车辆相关信息 -->
	<select id="getOrgOrderVehicleByOrder" resultType="map" parameterType="string">
		select
			(select le_vehiclemodels.name from le_vehiclemodels where org_order.factmodel = le_vehiclemodels.id) factmodelname,
			(select le_vehiclemodels.name from le_vehiclemodels where org_order.pricemodel = le_vehiclemodels.id) pricemodelname,
			pub_vehcbrand.name vehcbrandname, pub_vehcline.name vehclinename,
			concat((select text from pub_dictionary where type = '车牌省' and value = pub_vehicle.platenoprovince),
			(select text from pub_dictionary where type = '车牌市' and value = pub_vehicle.platenocity), pub_vehicle.plateno) plateno
		from
			org_order left join pub_vehicle on org_order.vehicleid = pub_vehicle.id
			left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
			left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
		where
			org_order.orderno = #{orderno}
	</select>
	
	<!-- 更新订单的车辆相关信息 -->
	<update id="updateOrgOrderVehicleByOrderno" parameterType="OrgOrder">
		update org_order set factmodelname = #{factmodelname}, pricemodelname = #{pricemodelname},
		vehcbrandname = #{vehcbrandname}, vehclinename = #{vehclinename}, plateno = #{plateno},
		belongleasecompany = #{belongleasecompany} 
		where orderno = #{orderno}
	</update>
	
	<!-- 查询客服备注列表 -->
	<select id="getOrgOrderCommentListByQuery" resultType="map" parameterType="OrdercommentQueryParam">
		select
			org_ordercomment.id, org_ordercomment.remark, org_ordercomment.operator, org_ordercomment.remarktype,
			date_format(org_ordercomment.createtime, '%Y.%m.%d %H:%i') createtime,
			le_rolemanagement.rolename, le_user.nickname, le_user.specialstate
		from
			org_ordercomment left join le_roleuser on org_ordercomment.operator = le_roleuser.userid
			left join le_rolemanagement on le_roleuser.roleid = le_rolemanagement.id
			left join le_user on org_ordercomment.operator = le_user.id
		where
			org_ordercomment.orderno = #{orderno} and org_ordercomment.status = 1
		order by org_ordercomment.createtime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOrgOrderCommentCountByQuery" resultType="int" parameterType="OrdercommentQueryParam">
		select
			count(*)
		from
			org_ordercomment
		where
			org_ordercomment.orderno = #{orderno} and org_ordercomment.status = 1
	</select>
	
	<!-- 添加客服备注 -->
	<select id="insertOrgOrdercomment" parameterType="OrgOrdercomment">
		insert into org_ordercomment(id, orderno, remarktype, remark, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{remarktype}, #{remark}, #{operator}, now(), now(), 1)
	</select>
	
	<!-- 订单号联想框(select2) -->
	<select id="getOrdernoBySelect" resultType="map" parameterType="OrderManageQueryParam">
		select
			org_order.orderno id, org_order.orderno text
		from
			org_order
		where
			org_order.status = 1 and org_order.companyid = #{leasescompanyid}
			
			<if test='null != orderNo'>
				and org_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='type == "1"'>
				and org_order.orderstatus = '1'
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "2"'>
				and org_order.orderstatus in ('2', '3', '4', '5', '6')
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "3"'>
				and org_order.reviewstatus = "1"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1"))
				</if>
			</if>
			
			<if test='type == "4"'>
				and org_order.reviewstatus = "2"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and org_order.paymentstatus = "4"
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus in ("0", "1")
				</if>
			</if>
			
			<if test='type == "5"'>
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and (org_order.orderstatus = '8' or org_order.paymentstatus = '3')
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and (org_order.orderstatus = '8' or org_order.paymentstatus = '1')
				</if>
			</if>
			
			<if test='type == "6"'>
				and org_order.orderstatus = "7"
				<if test='usetype == "0"'>
					and org_order.paymethod = "2" and org_order.paymentstatus in ("2", "4")
				</if>
				<if test='usetype == "1"'>
					and (org_order.paymethod in ("0", "1")) and org_order.paymentstatus = "0"
				</if>
			</if>
			<include refid="getOrderListByOrganSQL"></include>
	</select>
	
	<!-- 查询最近一次的订单复核记录 -->
	<select id="getOrgOrderreviewLastByOrderno" parameterType="string" resultType="OrgOrderReview">
		select * from org_orderreview where orderno = #{orderno} order by createtime desc limit 1
	</select>
	
	<update id="orderReject" parameterType="OrgOrder">
		update org_order set updatetime = now(), reviewstatus = #{reviewstatus} where orderno = #{orderno}
	</update>

    <!-- 获取订单列表中的服务车企(select2) -->
    <select id="getBelongCompanySelect" resultType="map" parameterType="OrderManageQueryParam">
        select id, shortname text from le_leasescompany
        where id in
          (select belongleasecompany from org_order left join org_ordercancel on org_order.orderno = org_ordercancel.orderno
            where org_order.status = 1 and org_ordercancel.status = 1 and org_order.companyid = #{leasescompanyid}
                  and org_order.usetype = #{usetype}
                <if test='"2" == type'>
                    and org_order.orderstatus in ('2', '3', '4', '5', '6')
                </if>
                <if test='"3" == type'>
                    and org_order.reviewstatus = "1"
                </if>
                <if test='"5" == type'>
                    and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))
                    <if test='usetype == "0"'>
                        and org_order.paymentstatus in ("0", "2", "4")
                    </if>
                    <if test='usetype == "1"'>
                        and org_order.paymentstatus = "0"
                    </if>
                </if>
                <if test='"6" == type'>
                    and (org_order.orderstatus = "7" or (org_order.orderstatus = "8" and org_ordercancel.cancelnature = 1))
                    <if test='usetype == "0"'>
                        and org_order.paymentstatus in ("1", "3", "9")
                    </if>
                    <if test='usetype == "1"'>
                        and org_order.paymentstatus in ("1", "9")
                    </if>
                </if>
                <if test='"7" == type'>
                    and org_order.orderstatus = "8"
                </if>
                <include refid="getOrderListByOrganSQL"></include>
            group by org_order.belongleasecompany
          )
    </select>

    <!-- 修改司机状态为空闲 -->
    <update id="updatePubDriverLeisure" parameterType="string">
        update pub_driver set workstatus = "0", updatetime = now() where id = #{driverid}
    </update>

    <!-- ======================================订单服务结束使用START====================================  -->

    <!-- 查询订单详情 -->
    <select id="getOrgOrderInfoByOrderno" parameterType="string" resultType="OrderInfoDetail">
      select
        0 orderprop, org_user.nickname username, org_user.account userphone, org_user.headportraitmin passengericonmin,
        org_user.headportraitmax passengericonmax, le_leasescompany.servicesphone contact, le_vehiclemodels.name cartype,
        le_vehiclemodels.logo cartypelogo, pub_cityaddr.city city, timestampdiff(second, org_order.starttime, org_order.endtime) times,
        org_order.paymethod, org_order.organid, org_order.isusenow, org_order.ordersource, org_order.pricecopy, org_order.undertime,
		org_order.ordertime, org_order.departuretime, org_order.arrivaltime, org_order.starttime, org_order.endtime, org_order.completetime,
		org_order.canceltime, org_order.mileage, org_order.orderno, org_order.ordertype type, org_order.onaddress, org_order.offaddress,
		org_order.usetime usetime, org_order.tripremark remark, org_order.orderstatus status, org_order.paymentstatus paystatus,
		org_order.reviewstatus, org_order.onaddrlng onlng, org_order.onaddrlat onlat, org_order.offaddrlng offlng, org_order.offaddrlat offlat,
		org_order.passengers passengers, org_order.passengerphone passengerphone, org_order.estimatedtime, org_order.estimatedmileage,
		org_order.estimatedcost, org_order.orderamount, org_order.fltno, org_order.falltime, org_order.userrate, org_order.usercomment,
		org_order.driverid, org_order.vehicleid, org_order.companyid, org_order.oncity cityid, org_order.usetype
	  from
		org_order left join le_vehiclemodels on le_vehiclemodels.status = 1 and org_order.pricemodel = le_vehiclemodels.id
		left join pub_cityaddr on pub_cityaddr.status = 1 and org_order.oncity = pub_cityaddr.id
		left join org_user on org_user.status = 1 and org_order.userid = org_user.id
		left join le_leasescompany on le_leasescompany.status = 1 and org_order.companyid = le_leasescompany.id
	  where org_order.status = 1 and org_order.orderno = #{orderno}
    </select>

    <!-- 更新订单信息 -->
    <update id="updateOrgOrderInfo" parameterType="OrderInfoDetail">
        update org_order set updatetime = now(), orderstatus = #{status}, endcity = #{cityintime}, endaddress = #{addressintime},
		  endlng = #{lng}, endllat = #{lat}
		where orderno = #{orderno}
    </update>

    <!-- 查询城市id -->
    <select id="getPubCityByName" parameterType="string" resultType="PubCityAddr">
        select * from pub_cityaddr where city = #{cityname} and status = 1
    </select>

    <!-- 更新司机信息 -->
    <update id="updatePubDriver" parameterType="PubDriver">
        update pub_driver set updatetime = now(), ordercount = #{orderCount}, workStatus = #{workStatus} where id = #{id}
    </update>

    <!-- ======================================订单服务结束使用END====================================  -->

</mapper>