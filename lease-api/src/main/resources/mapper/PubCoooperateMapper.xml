<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 引入接口，只要实现接口的方法就会调用对应接口方法的 select id -->
<mapper namespace="com.szyciov.lease.mapper.PubCoooperateMapper">
    <!-- parameterType传入参数类型     resultMap=自己定义的一个返回类型     resultType返回类型 -->
    <!-- 联盟资源 首页分页查询返回list -->
    <select id="getPubCoooperateList" resultType="PubCoooperate" parameterType="QueryParam">
        SELECT
        t1.*, t2.`name` AS companyName,
        (SELECT count(*) FROM pub_cooresource t3 WHERE t1.id = t3.coooperateid AND t3.`status` = 1) AS allCount,
        (SELECT count(*) FROM pub_cooresource t3 WHERE t1.id = t3.coooperateid AND t3.`status` = 1 AND t3.enabled = 0) AS availableCount
        FROM
        pub_coooperate t1
        LEFT JOIN le_leasescompany t2 ON (t1.leasecompanyid = t2.id AND t2.`Status`=1)
        WHERE 1 = 1
        AND t1.`status` = 1
        AND t1.platformtype = 1
        AND t1.companyid = #{key}
        <if test="queryCoono != null and queryCoono != '' ">
            AND t1.coono like "%"#{queryCoono}"%"
        </if>
        <if test="queryCompanyname != null and queryCompanyname != '' ">
            AND t1.leasecompanyid = #{queryCompanyname}
        </if>
        <if test="queryServicetype != null and queryServicetype != '' ">
            AND t1.servicetype = #{queryServicetype}
        </if>
        ORDER BY t1.updatetime DESC
        LIMIT #{iDisplayStart},#{iDisplayLength}
    </select>
    <!-- 联盟资源 查询返回数据数 -->
    <select id="getPubCoooperateListCount" resultType="int" parameterType="QueryParam">
        SELECT
        count(*)
        FROM
        pub_coooperate t1
        LEFT JOIN le_leasescompany t2 ON (t1.leasecompanyid = t2.id AND t2.`Status`=1)
        WHERE 1 = 1
        AND t1.`status` = 1
        AND t1.platformtype = 1
        AND t1.companyid = #{key}
        <if test="queryCoono != null and queryCoono != '' ">
            AND t1.coono like "%"#{queryCoono}"%"
        </if>
        <if test="queryCompanyname != null and queryCompanyname != '' ">
            AND t1.leasecompanyid = #{queryCompanyname}
        </if>
        <if test="queryServicetype != null and queryServicetype != '' ">
            AND t1.servicetype = #{queryServicetype}
        </if>
        ORDER BY t1.updatetime DESC
        LIMIT #{iDisplayStart},#{iDisplayLength}
    </select>
    <!-- 联盟资源  加载战略伙伴 -->
    <select id="getCompanyNameList" parameterType="String" resultType="PubCoooperate">
        SELECT
        t1.*, t2.`name` AS companyName
        FROM
        pub_coooperate t1
        LEFT JOIN le_leasescompany t2 ON (t1.leasecompanyid = t2.id AND t2.`Status`=1)
        WHERE 1 = 1
        AND t1.`status` = 1
        AND t1.platformtype = 1
        AND t1.companyid = #{id}
        GROUP BY t2.`name`
        ORDER BY t1.updatetime DESC
    </select>
    <!-- 查询资源信息 -->
    <select id="getResourceInformationList" parameterType="QueryParam" resultType="PubCoooperate">
        SELECT
        CONCAT(
        ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenoprovince AND t5.`status` = 1 ),
        ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenocity AND t5.`status` = 1 ),
        t3.plateno ) AS plateno	,
        CONCAT(t1.`name`, " ", t1.phone) AS driverInformation,
        t1.jobnum AS jobnum
        FROM
        pub_driver t1,
        pub_driver_vehicle_ref t2
        LEFT JOIN pub_vehicle t3 ON ( t2.vehicleid = t3.id AND t3.`Status` = 1 AND t3.platformtype = 1 ),
        pub_coooperate t4
        WHERE
        1 = 1
        AND t1.`Status` = 1
        AND t1.platformtype = 1
        AND t1.id = t2.driverid
        AND t2.`status` = 1
        AND (
        (
        t1.vehicletype = '1'
        AND t1.id = t3.driverid
        AND t1.passworkstatus IN ('0', '1', '3')
        )
        OR (t1.vehicletype = '0')
        )
        AND t1.leasescompanyid = t4.leasecompanyid
        AND t4.`status` = 1
        AND t4.platformtype = 1
        AND t4.id = #{key}
        AND t3.vehicletype = #{servicetype}
        <if test="queryPlateno != null and queryPlateno != '' ">
            AND CONCAT(
            ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenoprovince AND t5.`status` = 1 ),
            ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenocity AND t5.`status` = 1 ),
            t3.plateno ) like "%"#{queryPlateno}"%"
        </if>
        <if test="queryJobnum != null and queryJobnum != '' ">
            AND t1.jobnum like "%"#{queryJobnum}"%"
        </if>
        <if test="queryDriverInformation != null and queryDriverInformation != '' ">
            AND (t1.`name` like "%"#{queryDriverInformation}"%" OR t1.phone like "%"#{queryDriverInformation}"%")
        </if>
        LIMIT #{iDisplayStart},#{iDisplayLength}
    </select>
    <select id="getResourceInformationListCount" parameterType="QueryParam" resultType="int">
        SELECT
        COUNT(*)
        FROM
        pub_driver t1,
        pub_driver_vehicle_ref t2
        LEFT JOIN pub_vehicle t3 ON ( t2.vehicleid = t3.id AND t3.`Status` = 1 AND t3.platformtype = 1 ),
        pub_coooperate t4
        WHERE
        1 = 1
        AND t1.`Status` = 1
        AND t1.platformtype = 1
        AND t1.id = t2.driverid
        AND t2.`status` = 1
        AND (
        (
        t1.vehicletype = '1'
        AND t1.id = t3.driverid
        AND t1.passworkstatus IN ('0', '1', '3')
        )
        OR (t1.vehicletype = '0')
        )
        AND t1.leasescompanyid = t4.leasecompanyid
        AND t4.`status` = 1
        AND t4.platformtype = 1
        AND t4.id = #{key}
        AND t3.vehicletype = #{servicetype}
        <if test="queryPlateno != null and queryPlateno != '' ">
            AND CONCAT(
            ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenoprovince AND t5.`status` = 1 ),
            ( SELECT text FROM pub_dictionary t5 WHERE t5.`value` = t3.platenocity AND t5.`status` = 1 ),
            t3.plateno ) like "%"#{queryPlateno}"%"
        </if>
        <if test="queryJobnum != null and queryJobnum != '' ">
            AND t1.jobnum like "%"#{queryJobnum}"%"
        </if>
        <if test="queryDriverInformation != null and queryDriverInformation != '' ">
            AND (t1.`name` like "%"#{queryDriverInformation}"%" OR t1.phone like "%"#{queryDriverInformation}"%")
        </if>
    </select>
    <!-- 查询联盟资源 返回 list 有多少条数据 -->
    <select id="getDriverInformationList" resultType="DriverInformationDto" parameterType="QueryParam">
        SELECT
        t3.id,
        t1.leasescompanyid,
        CONCAT(t1.`name`," ",t1.phone) AS `name`,
        t1.jobnum,
        t3.vehicletype,
        IF(t3.vehicletype = 1 AND t1.passworkstatus = 1,
        (
        CONCAT(
        (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌省' AND pub_dictionary.`value`= t3.platenoprovince AND pub_dictionary.`status`=1),
        (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌市' AND pub_dictionary.`value`= t3.platenocity AND pub_dictionary.`status`=1),
        t3.plateno
        )
        ),
        (
        CONCAT(
        CONCAT(
        t5.`name`,
        ' '
        ),
        CONCAT(
        (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌省' AND pub_dictionary.`value`= t3.platenoprovince AND pub_dictionary.`status`=1),
        (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌市' AND pub_dictionary.`value`= t3.platenocity AND pub_dictionary.`status`=1),
        t3.plateno
        )
        )
        )) AS vehicleInfo,
        CONCAT(
        t7.`name`,
        " ",
        (
        SELECT
        pub_dictionary.text
        FROM
        pub_dictionary
        WHERE
        pub_dictionary.type = '车牌省'
        AND pub_dictionary.`value` = t3.platenoprovince
        AND pub_dictionary.`status` = 1
        ),
        (
        SELECT
        pub_dictionary.text
        FROM
        pub_dictionary
        WHERE
        pub_dictionary.type = '车牌市'
        AND pub_dictionary.`value` = t3.platenocity
        AND pub_dictionary.`status` = 1
        ),
        t3.plateno
        ) AS distributionVel,
        t6.updatetime AS distributionVelTime
        FROM
        pub_driver t1,
        pub_driver_vehicle_ref t2
        LEFT JOIN pub_vehicle t3 ON t2.vehicleid = t3.id AND t3.`Status`=1 AND t3.platformtype=1
        LEFT JOIN le_vehcline_models_ref t4 ON t3.vehclineid = t4.vehclineid AND t4.`Status`=1
        LEFT JOIN le_vehiclemodels t5 ON t4.vehiclemodelsid = t5.Id AND t5.`Status`=1
        LEFT JOIN pub_vehicle_models_ref t6 ON t6.vehicleid = t3.id AND t6.`status`=1 AND t6.companyid = #{key}
        LEFT JOIN le_vehiclemodels t7 ON t7.Id = t6.vehiclemodelsid AND t7.`status`=1
        WHERE
        t1.leasescompanyid = #{leasescompanyid}
        AND t1.`Status`=1
        AND t1.platformtype=1
        AND t1.id = t2.driverid
        AND t2.`status`=1
        AND t3.vehicletype = #{servicetype}
        AND ((t1.vehicletype = '1' AND t1.id = t3.driverid AND t1.passworkstatus IN( '0' ,'1' ,'3')) OR (t1.vehicletype = '0'))
        <if test="queryPlateno != null and queryPlateno != '' ">
            AND CONCAT(
            (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌省' AND pub_dictionary.`value`= t3.platenoprovince AND pub_dictionary.`status`=1),
            (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌市' AND pub_dictionary.`value`= t3.platenocity AND pub_dictionary.`status`=1),
            t3.plateno
            ) like "%"#{queryPlateno}"%"
        </if>
        <if test="queryJobnum != null and queryJobnum != '' ">
            AND t1.jobnum like "%"#{queryJobnum}"%"
        </if>
        <if test="queryDriverInformation != null and queryDriverInformation != '' ">
            AND CONCAT(t1.`name`," ",t1.phone) like "%"#{queryDriverInformation}"%"
        </if>
        <if test="queryModels != null and queryModels != '' ">
            AND t7.`name`=#{queryModels}
        </if>
        LIMIT #{iDisplayStart},#{iDisplayLength}
    </select>
    <!-- 查询联盟资源 返回 count 有多少条数据 -->
    <select id="getDriverInformationListCount" resultType="int" parameterType="QueryParam">
        SELECT count(*) FROM
        pub_driver t1,
        pub_driver_vehicle_ref t2
        LEFT JOIN pub_vehicle t3 ON t2.vehicleid = t3.id AND t3.`Status`=1 AND t3.platformtype=1
        LEFT JOIN le_vehcline_models_ref t4 ON t3.vehclineid = t4.vehclineid AND t4.`Status`=1
        LEFT JOIN le_vehiclemodels t5 ON t4.vehiclemodelsid = t5.Id AND t5.`Status`=1
        LEFT JOIN pub_vehicle_models_ref t6 ON t6.vehicleid = t3.id AND t6.`status`=1 AND t6.companyid = #{key}
        LEFT JOIN le_vehiclemodels t7 ON t7.Id = t6.vehiclemodelsid AND t7.`status`=1
        WHERE
        t1.leasescompanyid = #{leasescompanyid}
        AND t1.`Status`=1
        AND t1.platformtype=1
        AND t1.id = t2.driverid
        AND t2.`status`=1
        AND t3.vehicletype = #{servicetype}
        AND ((t1.vehicletype = '1' AND t1.id = t3.driverid AND t1.passworkstatus IN( '0' ,'1' ,'3')) OR (t1.vehicletype = '0'))
        <if test="queryPlateno != null and queryPlateno != '' ">
            AND CONCAT(
            (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌省' AND pub_dictionary.`value`= t3.platenoprovince AND pub_dictionary.`status`=1),
            (SELECT pub_dictionary.text FROM pub_dictionary WHERE pub_dictionary.type='车牌市' AND pub_dictionary.`value`= t3.platenocity AND pub_dictionary.`status`=1),
            t3.plateno
            ) like "%"#{queryPlateno}"%"
        </if>
        <if test="queryJobnum != null and queryJobnum != '' ">
            AND t1.jobnum like "%"#{queryJobnum}"%"
        </if>
        <if test="queryDriverInformation != null and queryDriverInformation != '' ">
            AND CONCAT(t1.`name`," ",t1.phone) like "%"#{queryDriverInformation}"%"
        </if>
        <if test="queryModels != null and queryModels != '' ">
            AND t7.`name`=#{queryModels}
        </if>
    </select>
    <!-- 查询 联盟资源  服务车型-->
    <select id="getModelsList" resultType="DriverInformationDto" parameterType="QueryParam">
        select t2.name from pub_vehicle_models_ref t1,le_vehiclemodels t2
        where t1.vehiclemodelsid = t2.id
        and t1.companyid = #{key}
        and t1.leasecompanyid = #{leasescompanyid}
        and t1.status=1
        and t2.status=1
        group by t2.name
    </select>
    <!-- 加载原服务车型 -->
    <select id="getOriginalModels" resultType="DriverInformationDto" parameterType="map">
        <!-- SELECT t3.name FROM pub_vehicle t1,le_vehcline_models_ref t2,le_vehiclemodels t3
        WHERE 1=1
        AND t1.vehclineid = t2.vehclineid
        AND t3.id = t2.vehiclemodelsid
        AND t1.platformtype = 1
        AND t1.`Status`=1
        AND t2.`status` = 1
        AND t3.`Status`=1
        AND t1.leasescompanyid=#{leasescompanyid}
        AND t1.id = #{vehicleid} -->

        SELECT
        t6.id as id,t5.name as originalName,t7.name as nowName
        FROM
        pub_driver t1,
        pub_driver_vehicle_ref t2
        LEFT JOIN pub_vehicle t3 ON t2.vehicleid = t3.id AND t3.`Status`=1 AND t3.platformtype=1
        LEFT JOIN le_vehcline_models_ref t4 ON t3.vehclineid = t4.vehclineid AND t4.`Status`=1
        LEFT JOIN le_vehiclemodels t5 ON t4.vehiclemodelsid = t5.Id AND t5.`Status`=1
        LEFT JOIN pub_vehicle_models_ref t6 ON t6.vehicleid = t3.id AND t6.`status`=1 AND t6.companyid = #{id}
        LEFT JOIN le_vehiclemodels t7 ON t7.Id = t6.vehiclemodelsid AND t7.`status`=1
        WHERE
        t1.leasescompanyid = #{leasescompanyid}
        AND t3.id = #{vehicleid}
        AND t1.`Status`=1
        AND t1.platformtype=1
        AND t1.id = t2.driverid
        AND t2.`status`=1
        AND ((t1.vehicletype = '1' AND t1.id = t3.driverid AND t1.passworkstatus IN( '0' ,'1' ,'3')) OR (t1.vehicletype = '0'))
    </select>
    <!-- 加载现在的服务车型 -->
    <select id="getLeVehiclemodels" resultType="LeVehiclemodels" parameterType="map">
        SELECT * FROM le_vehiclemodels WHERE leasescompanyid = #{leasescompanyid} AND `Status`=1
    </select>
    <insert id="createPubVehicleModelsRef" parameterType="PubVehicleModelsRef">
        INSERT INTO `pub_vehicle_models_ref` (`id`, `companyid`, `leasecompanyid`, `vehicleid`, `vehiclemodelsid`, `createtime`, `updatetime`, `creater`, `updater`, `status`)
        VALUES (#{id}, #{companyid}, #{leasecompanyid}, #{vehicleid}, #{vehiclemodelsid}, now(), now(), #{creater}, #{updater}, '1');
    </insert>
    <insert id="createPubVehicleModelsRefHistory" parameterType="PubVehicleModelsRef">
        INSERT INTO `pub_vehicle_models_ref_history` (`id`, `companyid`, `leasecompanyid`, `vehicleid`, `vehiclemodelsid`, `createtime`, `updatetime`, `creater`, `updater`, `status`)
        VALUES (#{id}, #{companyid}, #{leasecompanyid}, #{vehicleid}, #{vehiclemodelsid}, now(), now(), #{creater}, #{updater}, '1');
    </insert>
    <insert id="updatePubVehicleModelsRef" parameterType="PubVehicleModelsRef">
        update `pub_vehicle_models_ref` set vehiclemodelsid = #{vehiclemodelsid} , updatetime = now(),updater = #{updater} where id = #{id}
    </insert>
</mapper>