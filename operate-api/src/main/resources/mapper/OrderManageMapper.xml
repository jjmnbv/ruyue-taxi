<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.szyciov.operate.mapper.OrderManageMapper">
	<select id="getPubDriver" parameterType="String" resultType="PubDriver">
	SELECT * FROM pub_driver where status = 1 AND id = #{id}
	</select>
	<!-- 分页查询订单数据 -->
	<sql id="getOrderCitySQL">
		<if test='usertype == "0"'>
			and (op_order.oncity in
			(select le_accountrules.city
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 1
			left join le_accountrules on le_leasescompany.id = le_accountrules.leasescompanyid and le_accountrules.type = '0' and le_accountrules.rulesstate = '0'
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_accountrules.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			or
			op_order.oncity in (select op_accountrules.city from op_accountrules where exists
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 0
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			and op_accountrules.rulesstate = "0" and op_accountrules.status = 1))
		</if>
	</sql>
	<sql id="getOrderLeaseSQL">
		<if test='usertype == "0"'>
			and op_order.companyid in
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id
			where op_roleuser.status = 1 and op_roledataauthority.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
		</if>
	</sql>
	
	<!-- 待接订单 -->
	<select id="getOpLabourOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.userid, pe_user.nickname, pe_user.account,
            op_order.passengers, op_order.passengerphone, op_order.undertime, op_order.usetime,
			op_order.pushnumber, op_order.orderstatus, op_order.usetype,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress
		from
			op_order left join pe_user on op_order.userid = pe_user.id
		where
			op_order.status = 1 and op_order.orderstatus in ("0", "1")

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.undertime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.undertime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
			<include refid="getOrderCitySQL"></include>
		order by
			op_order.createtime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpLabourOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
            op_order.status = 1 and op_order.orderstatus in ("0", "1")

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.undertime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.undertime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderCitySQL"></include>
	</select>
	
	<!-- 当前订单 -->
	<select id="getOpCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.userid, pe_user.nickname, pe_user.account, op_order.usetype,
			op_order.passengers, op_order.passengerphone, op_order.driverid, op_order.usetime, op_order.belongleasecompany, op_order.companyid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname
		from
			op_order left join pe_user on op_order.userid = pe_user.id
		where
			op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != orderstatus and "" != orderstatus'>
                and op_order.orderstatus = #{orderstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
			<include refid="getOrderCitySQL"></include>
		order by
			op_order.orderstatus asc,
			case when op_order.orderstatus = '2' then op_order.usetime else '' end asc,
			case when op_order.orderstatus != '2' then op_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
            op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != orderstatus and "" != orderstatus'>
                and op_order.orderstatus = #{orderstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderCitySQL"></include>
	</select>

	<!-- 待复核订单 -->
	<select id="getOpAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson,
			op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.starttime, op_order.endtime, op_order.usetime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname,
            op_order.shouldpayamount, op_order.belongleasecompany, op_order.companyid,
			ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.times reviewtimes, tmp.counttimes reviewcounttimes, tmp.id reviewid,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = op_order.orderno) actualamount
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
		where
			op_order.status = 1 and op_order.reviewstatus = "1"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and op_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
            op_order.status = 1 and op_order.reviewstatus = "1"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and op_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderLeaseSQL"></include>
	</select>
	
	<!-- 已复核订单 -->
	<select id="getOpWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson,
            op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.starttime, op_order.endtime,
            op_order.originalorderamount, op_order.shouldpayamount, op_order.actualpayamount, tmp.reviewtype,
			tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes,
			tmp.id reviewid, tmp.rawpricecopy, op_order.companyid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = op_order.orderno) actualamount
		from
			op_order left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
		where
			op_order.status = 1 and op_order.reviewstatus = "2"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and op_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
            op_order.status = 1 and op_order.reviewstatus = "2"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != reviewperson and "" != reviewperson'>
                and op_order.reviewperson = #{reviewperson}
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>
            <include refid="getOrderLeaseSQL"></include>
	</select>

    <!-- 待收款订单 -->
    <select id="getOpWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
        select
            op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.orderamount, op_order.mileage,
            op_order.pricecopy, op_order.reviewstatus, op_order.starttime, op_order.endtime, op_order.usetime, op_order.shouldpayamount,
            op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
            (select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress,
            op_order.expensetype, op_ordercancel.cancelamount, op_order.companyid,
            ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname
        from
            op_order left join pe_user on op_order.userid = pe_user.id
            left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
            left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
        where
            op_order.status = 1 and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
            and op_order.paymentstatus = "0"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and op_order.expensetype = #{expensetype}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderLeaseSQL"></include>
        order by
          op_order.usetime desc
        limit #{iDisplayStart}, #{iDisplayLength}
    </select>
    <select id="getOpWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
        select
          count(*)
        from
            op_order left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
        where
            op_order.status = 1 and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
            and op_order.paymentstatus = "0"

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and op_order.expensetype = #{expensetype}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderLeaseSQL"></include>
    </select>

    <!-- 已完成订单 -->
	<select id="getOpCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.paymentstatus, op_order.paytype,
			op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.factmodelname, op_order.starttime,
            op_order.endtime, op_order.usetime, op_order.undertime, op_order.ordertime, op_order.expensetype,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername, op_order.companyid, op_order.actualpayamount,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress,
			op_order.cancelparty, op_order.reviewstatus, op_orderpaymentrecord.tradeno, op_ordercancel.cancelamount, op_order.factmodelname,
            op_order.shouldpayamount, pub_driver.jobnum, op_order.plateno, op_order.estimatedtime, op_order.estimatedmileage, op_order.factmodelname,
            ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname,
            (select pub_coupon_use.actualamount from pub_coupon_use where pub_coupon_use.status = 1
                and pub_coupon_use.usetype = 2 and pub_coupon_use.usestate = 1 and pub_coupon_use.billingorderid = op_order.orderno) actualamount
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
			left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
			left join pub_driver on op_order.driverid = pub_driver.id
            left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
		where
			op_order.status = 1 and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
            and op_order.paymentstatus in ("1", "9")

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != paytype and "" != paytype'>
                and op_order.paytype = #{paytype}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and op_order.expensetype = #{expensetype}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderLeaseSQL"></include>
		order by
			op_order.usetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
            left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
        where
            op_order.status = 1 and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
            and op_order.paymentstatus in ("1", "9")

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != paytype and "" != paytype'>
                and op_order.paytype = #{paytype}
            </if>

            <if test='null != paymentstatus and "" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus}
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != expensetype and "" != expensetype'>
                and op_order.expensetype = #{expensetype}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
            <include refid="getOrderLeaseSQL"></include>
	</select>

    <!-- 已取消订单列表查询 -->
    <select id="getOpCancelOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
        select
            op_order.orderno, op_order.paymentstatus, op_order.ordertype, op_order.cancelparty, op_order.canceltime,
            op_order.paytype, op_order.userid, pe_user.nickname, pe_user.account,op_order.passengers,
            op_order.passengerphone, op_order.driverid, op_order.companyid, op_order.belongleasecompany,
            op_ordercancel.cancelnature, op_ordercancel.dutyparty, op_ordercancel.cancelamount, op_ordercancel.cancelreason,
            op_ordercancel.exemption, op_orderpaymentrecord.tradeno, pe_user.status userstatus, op_order.usetime,
            (select op_user.nickname from op_user where op_user.id = op_ordercancel.canceloperator) cancelname,
            (select op_user.nickname from op_user where op_user.id = op_ordercancel.exemptionoperator) exemptionname,
            concat(pub_driver.name, " ", pub_driver.phone) drivername,
            getCityStr(op_order.oncity) oncityname, op_order.oncity, op_order.onaddress,
            getCityStr(op_order.offcity) offcityname, op_order.offcity, op_order.offaddress,
            (select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongcompanyname
        from
            op_order left join pe_user on op_order.userid = pe_user.id
            left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
            left join pub_driver on op_order.driverid = pub_driver.id
            left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
        where
            op_order.status = 1 and op_order.orderstatus = "8"
            and ((not isnull(op_order.companyid) and op_order.companyid != "" <include refid="getOrderLeaseSQL"></include>)
            or ((isnull(op_order.companyid) or op_order.companyid = "") <include refid="getOrderCitySQL"></include>))

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != paymentstatus and "10" == paymentstatus'>
                and op_ordercancel.cancelnature = 2
            </if>
            <if test='null != paymentstatus and "" != paymentstatus and "10" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus} and op_ordercancel.cancelnature = 1
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != cancelparty and "" != cancelparty'>
                and op_order.cancelparty = #{cancelparty}
            </if>

            <if test='null != cancelnature'>
                and op_ordercancel.cancelnature = #{cancelnature}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
        order by
          op_order.usetime desc
        limit #{iDisplayStart}, #{iDisplayLength}
    </select>
    <select id="getOpCancelOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
        select
            count(*)
        from
            op_order left join pe_user on op_order.userid = pe_user.id
            left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
            left join pub_driver on op_order.driverid = pub_driver.id
            left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
        where
            op_order.status = 1 and op_order.orderstatus = "8"
            and ((not isnull(op_order.companyid) and op_order.companyid != "" <include refid="getOrderLeaseSQL"></include>)
            or ((isnull(op_order.companyid) or op_order.companyid = "") <include refid="getOrderCitySQL"></include>))

            <if test='null != ordersource and "" != ordersource'>
                and op_order.orderno like concat(#{ordersource}, '%')
            </if>

            <if test='null != orderType and "" != orderType'>
                and op_order.ordertype = #{orderType}
            </if>

            <if test='null != belongleasecompany and "" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>

            <if test='null != paymentstatus and "10" == paymentstatus'>
                and op_ordercancel.cancelnature = 2
            </if>
            <if test='null != paymentstatus and "" != paymentstatus and "10" != paymentstatus'>
                and op_order.paymentstatus = #{paymentstatus} and op_ordercancel.cancelnature = 1
            </if>

            <if test='null != driverid and "" != driverid'>
                and op_order.driverid = #{driverid}
            </if>

            <if test='null != userId and "" != userId'>
                and op_order.userid = #{userId}
            </if>

            <if test='null != cancelparty and "" != cancelparty'>
                and op_order.cancelparty = #{cancelparty}
            </if>

            <if test='null != cancelnature'>
                and op_ordercancel.cancelnature = #{cancelnature}
            </if>

            <if test='null != orderNo and "" != orderNo'>
                and op_order.orderno like concat('%', #{orderNo}, '%')
            </if>

            <if test='null != tradeno and "" != tradeno'>
                and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
            </if>

            <if test='null != minUseTime and "" != minUseTime'>
                and op_order.usetime &gt;= date_format(#{minUseTime}, '%Y-%m-%d %T')
            </if>
            <if test='null != maxUseTime and "" != maxUseTime'>
                and op_order.usetime &lt;= date_format(#{maxUseTime}, '%Y-%m-%d %T')
            </if>
    </select>
	
    <!-- 查询派单规则中所有城市 -->
	<select id="getSendRulesByName" parameterType="string" resultType="map">
		select
            pub_sendrules.city id, pub_cityaddr.city text
		from
            pub_sendrules, pub_cityaddr
		where
            pub_sendrules.city = pub_cityaddr.id
			and pub_sendrules.status = 1
            and pub_sendrules.platformtype = "0"
            and pub_sendrules.vehicletype = 0
			and pub_cityaddr.status = 1
			<if test='null != _parameter and "" != _parameter'>
				and pub_cityaddr.city like concat("%", #{_parameter}, "%")
			</if>
	</select>
	
	<!-- 查询下单人列表信息 -->
	<select id="getPeUser" resultType="map" parameterType="string">
		select id, if(isnull(nickname) || nickname = '', account, concat(nickname, " ", account)) text
		from pe_user
		where disablestate = '0' and status = 1
		<if test='null != _parameter and "" != _parameter'>
			and (account like concat("%", #{_parameter}, "%") or nickname like concat("%", #{_parameter}, "%"))
		</if>
	</select>
	
	<!-- 查询订单详情 -->
	<select id="getOpOrderByOrderno" resultType="map" parameterType="string">
		select 
			op_order.*, pe_user.nickname, pe_user.account, pub_driver.name drivername, pub_driver.phone driverphone,
			getCityStr(op_order.oncity) oncityName, getCityStr(op_order.offcity) offcityName,
			ifnull(tmp.price, 0) price, tmp.starttime reviewstarttime, tmp.endtime reviewendtime, tmp.times reviewtimes,
			tmp.counttimes reviewcounttimes, tmp.mileage reviewmileage, tmp.timesubsidies reviewtimesubsidies, tmp.mileageprices reviewmileageprices,
			tmp.reviewtype, op_ordercancel.cancelnature, op_ordercancel.cancelamount, tmp.pricecopy reviewpricecopy, pub_coupon_use.actualamount,
			(select le_leasescompany.shortname from le_leasescompany where le_leasescompany.id = op_order.belongleasecompany) belongleasecompanytext
		from op_order left join pe_user on op_order.userid = pe_user.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp
				on op_order.orderno = tmp.orderno
			left join pub_driver on op_order.driverid = pub_driver.id
			left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
			left join pub_coupon_use on op_order.orderno = pub_coupon_use.billingorderid and pub_coupon_use.usestate = 1 and pub_coupon_use.usetype = 2
		where op_order.status = 1 and op_order.orderno = #{orderno} limit 1
	</select>
	
	<!-- 取消订单 -->
	<update id="cancelOpOrder" parameterType="string">
		update op_order set orderstatus = '8', cancelparty = '0', updatetime = now(), canceltime = now() where orderno = #{orderno}
	</update>
	
	<!-- 查询订单详情 -->
	<select id="getOpOrder" parameterType="string" resultType="OpOrder">
		select * from op_order where status = 1 and orderno = #{orderno}
	</select>
	
	<!-- 根据上车城市查询车型信息 -->
	<select id="getCompanyVehicleModel" parameterType="string" resultType="map">
		select
			op_vehiclemodels.id, op_vehiclemodels.name
		from
			op_accountrules left join op_vehiclemodels on op_accountrules.vehiclemodelsid = op_vehiclemodels.id,
			(select oncity, ordertype from op_order where orderno = #{orderno}) temp
		where
			op_accountrules.rulesstate = "0" and op_accountrules.status = 1
			and op_vehiclemodels.modelstatus = "0" and op_vehiclemodels.status = 1
			and op_accountrules.city = temp.oncity and op_accountrules.rulestype = temp.ordertype
	</select>
	
	<!-- 根据上车城市查询派单规则 -->
	<select id="getSendRulesList" parameterType="PubSendRules" resultType="PubSendRules">
		select * from pub_sendrules
		where status = 1 and pub_sendrules.platformtype = "0" and pub_sendrules.vehicletype = 0
		<if test='null != city and "" != city'>
			and city = #{city}
		</if>
        <if test='null != useType'>
            and usetype = #{useType}
        </if>
	</select>

    <!-- 分页查询司机 -->
	<select id="getDriverListByQuery" parameterType="OrderManageQueryParam" resultType="map">
        select
            pub_driver.id driverid, pub_driver.name drivername, pub_driver.workstatus, pub_driver.lat, pub_driver.lng,
            pub_driver.phone, pub_driver.headportraitmin, pub_driver.headportraitmax, op_vehiclemodels.id modelsid,
            op_vehiclemodels.name modelname, pub_driver.leasescompanyid, pub_vehicle.id vehicleid,
            concat(pub_vehcbrand.name, " ", pub_vehcline.name) brandname, pub_vehicle.fullplateno plateno
        from
            pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
            left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
            left join pub_vehicle_models_ref on pub_vehicle.id = pub_vehicle_models_ref.vehicleid
            left join op_vehiclemodels on pub_vehicle_models_ref.vehiclemodelsid = op_vehiclemodels.id
            left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
            left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
            left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
        where
            pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and pub_vehicle_models_ref.status = 1
            and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1 and pub_vehcline.status = 1 and pub_vehcbrand.status = 1
            and pub_driver.workstatus in ("0", "1", "2") and pub_vehicle_models_ref.companyid = #{leasescompanyid}

            <if test='null != isusenow and isusenow == 1'>
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6'))
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and org_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                ]]>)

                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6'))
                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and op_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                ]]>)
            </if>
            <if test='null != isusenow and isusenow == 0'>
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_add(org_order.usetime, interval (1) hour) <= #{usetime}
                ]]>)
                and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_format(org_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                ]]>)

                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_add(op_order.usetime, interval (1) hour) <= #{usetime}
                ]]>)
                and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                <![CDATA[
                    and date_format(op_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                ]]>)
            </if>

            <if test="driverid != null and driverid != ''">
                and pub_driver.id != #{driverid}
            </if>
            <if test="selectdriverid != null and selectdriverid != ''">
                and pub_driver.id = #{selectdriverid}
            </if>
            <if test="oncity != null and oncity != ''">
                and (pub_vehicle_scope.cityid = #{oncity}
                <if test="offcity != null and offcity != ''">
                    or pub_vehicle_scope.cityid = #{offcity}
                </if>
                )
            </if>
            <if test="driverState != null and driverState != ''">
                and pub_driver.workstatus = #{driverState}
            </if>
            <if test="selectedmodel != null and selectedmodel != ''">
                and op_vehiclemodels.id = #{selectedmodel}
            </if>
            <if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
                <![CDATA[
                    and pub_driver.lat >= ${minLat} and pub_driver.lat <= ${maxLat}
                ]]>
            </if>
            <if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
                <![CDATA[
                    and pub_driver.lng >= ${minLon} and pub_driver.lng <= ${maxLon}
                ]]>
            </if>
            <if test="driverName != null and driverName != ''">
                and pub_driver.name like "%"#{driverName}"%"
            </if>
            <if test="models == 1">
                and op_vehiclemodels.level >= (select level from op_vehiclemodels where id = #{orderSelectedmodel})
            </if>
            <if test="models == 0">
                and op_vehiclemodels.id = #{orderSelectedmodel}
            </if>
            <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
                and pub_driver.belongleasecompany = #{queryTmpBelongleasecompany}
            </if>
            and pub_driver.lng &gt; 0 and pub_driver.lat &gt; 0
            and pub_driver.vehicletype = "0"
            and op_vehiclemodels.id in (
                select
                  op_vehiclemodels.id
                from
                    op_accountrules left join op_vehiclemodels on op_accountrules.vehiclemodelsid = op_vehiclemodels.id
                where
                    op_accountrules.rulesstate = "0" and op_accountrules.status = 1
                    and op_vehiclemodels.modelstatus = "0" and op_vehiclemodels.status = 1
                    and op_accountrules.city = #{oncity} and op_accountrules.rulestype = #{orderType}
            )
            and pub_driver.phone not in (select account from pe_user where pe_user.id = #{userId} and pe_user.status = 1)
        group by pub_driver.id
        limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getDriverCountByQuery" parameterType="OrderManageQueryParam" resultType="int">
        select count(*) from (
            select
              pub_driver.id
            from
                pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
                left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
                left join pub_vehicle_models_ref on pub_vehicle.id = pub_vehicle_models_ref.vehicleid
                left join op_vehiclemodels on pub_vehicle_models_ref.vehiclemodelsid = op_vehiclemodels.id
                left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
                left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
                left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
            where
                pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and pub_vehicle_models_ref.status = 1
                and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1 and pub_vehcline.status = 1 and pub_vehcbrand.status = 1
                and pub_driver.workstatus in ("0", "1", "2") and pub_vehicle_models_ref.companyid = #{leasescompanyid}

                <if test='null != isusenow and isusenow == 1'>
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6'))
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and org_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                    ]]>)

                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6'))
                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and op_order.usetime <= date_format(#{estimatedEndtime}, '%Y-%m-%d %T')
                    ]]>)
                </if>
                <if test='null != isusenow and isusenow == 0'>
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 1 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_add(org_order.usetime, interval (1) hour) <= #{usetime}
                    ]]>)
                    and pub_driver.id not in (select pub_driver.id from org_order left join pub_driver on org_order.driverid = pub_driver.id where org_order.isusenow = 0 and org_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_format(org_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                    ]]>)

                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 1 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_add(op_order.usetime, interval (1) hour) <= #{usetime}
                    ]]>)
                    and pub_driver.id not in (select pub_driver.id from op_order left join pub_driver on op_order.driverid = pub_driver.id where op_order.isusenow = 0 and op_order.orderstatus in ('2', '3', '4', '6')
                    <![CDATA[
                        and date_format(op_order.usetime, '%Y-%m-%d') = date_format(#{usetime}, '%Y-%m-%d')
                    ]]>)
                </if>

                <if test="driverid != null and driverid != ''">
                    and pub_driver.id != #{driverid}
                </if>
                <if test="selectdriverid != null and selectdriverid != ''">
                    and pub_driver.id = #{selectdriverid}
                </if>
                <if test="oncity != null and oncity != ''">
                    and (pub_vehicle_scope.cityid = #{oncity}
                    <if test="offcity != null and offcity != ''">
                        or pub_vehicle_scope.cityid = #{offcity}
                    </if>
                    )
                </if>
                <if test="driverState != null and driverState != ''">
                    and pub_driver.workstatus = #{driverState}
                </if>
                <if test="selectedmodel != null and selectedmodel != ''">
                    and op_vehiclemodels.id = #{selectedmodel}
                </if>
                <if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
                    <![CDATA[
                        and pub_driver.lat >= ${minLat} and pub_driver.lat <= ${maxLat}
                    ]]>
                </if>
                <if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
                    <![CDATA[
                        and pub_driver.lng >= ${minLon} and pub_driver.lng <= ${maxLon}
                    ]]>
                </if>
                <if test="driverName != null and driverName != ''">
                    and pub_driver.name like "%"#{driverName}"%"
                </if>
                <if test="models == 1">
                    and op_vehiclemodels.level >= (select level from op_vehiclemodels where id = #{orderSelectedmodel})
                </if>
                <if test="models == 0">
                    and op_vehiclemodels.id = #{orderSelectedmodel}
                </if>
                <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
                    and pub_driver.belongleasecompany = #{queryTmpBelongleasecompany}
                </if>
                and pub_driver.lng &gt; 0 and pub_driver.lat &gt; 0
                and pub_driver.vehicletype = "0"
                and op_vehiclemodels.id in (
                    select
                      op_vehiclemodels.id
                    from
                      op_accountrules left join op_vehiclemodels on op_accountrules.vehiclemodelsid = op_vehiclemodels.id
                    where
                        op_accountrules.rulesstate = "0" and op_accountrules.status = 1
                        and op_vehiclemodels.modelstatus = "0" and op_vehiclemodels.status = 1
                        and op_accountrules.city = #{oncity} and op_accountrules.rulestype = #{orderType}
                )
                and pub_driver.phone not in (select account from pe_user where pe_user.id = #{userId} and pe_user.status = 1)
                group by pub_driver.id
        ) tmp
	</select>
	
	<!-- 根据车型查询计费规则 -->
	<select id="findModelPriceByModels" parameterType="map" resultType="OpAccountrules">
		select * from op_accountrules
		where city = #{city} 
		and vehiclemodelsid = #{cartype} 
		and rulestype = #{rulestype} 
		and rulesstate = 0 
		and status = 1
	</select>
	
	<!-- 人工派单修改订单数据 -->
	<update id="manualSendOrder" parameterType="OpOrder">
		update op_order set driverid=#{driverid}, companyid = #{companyid}, orderstatus='2', pricemodel = #{pricemodel}, factmodel = #{factmodel},
		pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), ordertime = now()
		where orderno=#{orderno}
	</update>
	
	<!-- 添加人工派单记录 -->
	<insert id="insertOpSendrecord" parameterType="OpSendrecord">
		insert into op_sendrecord(id, orderno, driverid, operator, chargemodel, reason, sendtime, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{driverid}, #{operator}, #{chargemodel}, #{reason}, now(), now(), now(), 1)
	</insert>
	
	<!-- 更换司机修改订单数据 -->
	<update id="changeOpDriver" parameterType="map">
		update op_order set updatetime=#{updatetime}, companyid = #{companyid}, driverid = #{newdriverid}, pricemodel = #{pricemodel},
		factmodel = #{factmodel}, pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), orderstatus = "2", ordertime = now()
		where orderno=#{orderno}
	</update>
	
	<!-- 添加更换司机记录 -->
	<insert id="insertOpDriverchanges" parameterType="OpDriverchanges">
		insert into op_driverchanges(id, orderno, beforedriverid, afterdriverid, chargemodel, reason, sendtime, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{beforedriverid}, #{afterdriverid}, #{chargemodel}, #{reason}, #{sendtime}, #{operator}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 复核订单修改订单数据 -->
	<update id="applyRecheckOrder" parameterType="map">
		update op_order set updatetime=now(),  orderreason = #{orderreason}, reviewperson = #{reviewperson}, reviewstatus = #{reviewstatus}
		where orderno=#{orderno}
	</update>
	
	<!-- 查询订单的人工派单记录 -->
	<select id="getOpSendOrderRecord" resultType="map" parameterType="string">
		select id, orderno, driverid, reason, operator, date_format(createtime, '%Y-%m-%d %H:%i') createtime, updatetime, status, 
		(select t1.nickname from op_user t1 where t.operator = t1.id) operatorname,
		(select CONCAT(t1.name,' ', t1.phone) from pub_driver t1 where t.driverid = t1.id) driverinfo
		from op_sendrecord t
		where orderno = #{orderno} and status = 1 limit 1
	</select>
	
	<!-- 查询订单更换司机记录 -->
	<select id="getOpChangeDriverListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*, (select CONCAT(t1.name, ' ', t1.phone) from pub_driver t1 where t1.id = t.beforedriverid) beforedriverinfo,  
		(select CONCAT(t1.name, ' ', t1.phone) from pub_driver t1 where t1.id = t.afterdriverid) afterdriverinfo,
		(select t1.nickname from op_user t1 where t.operator = t1.id) operatorname,
		date_format(t.sendtime, '%Y/%m/%d %H:%i') changetime
		from op_driverchanges t, (select @rownum :=0) b
		where orderno = #{orderNo} and status = 1 order by createtime desc
	</select>
	<select id="getOpChangeDriverCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from op_driverchanges where orderno = #{orderNo} and status = 1
	</select>
	
	<!-- 查询订单的复核记录 -->
	<select id="getOpOrderReviewListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
            (@rownum := @rownum + 1) rownum,
            op_orderreview.*,
            (select op_user.nickname from op_user where op_user.id = op_orderreview.operator) operatorname
		from
		    op_orderreview, (select @rownum :=0) b
		where op_orderreview.orderno = #{orderNo} and op_orderreview.status = 1
		order by op_orderreview.reviewtime desc
	</select>
	<select id="getOpOrderReviewCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from op_orderreview where orderno = #{orderNo} and status = 1
	</select>
	
	<!-- 修改订单数据 -->
	<update id="updateOrderState"  parameterType="OpOrder">
		update op_order set updateTime=now() 
		
		<if test="orderstatus != null">
			, orderstatus = #{orderstatus} 
		</if>
		
		<if test="reviewstatus != null">
			, reviewstatus = #{reviewstatus} 
		</if>
		
		<if test="paymentstatus != null">
			, paymentstatus = #{paymentstatus} 
		</if>
		
		<if test="orderreason != null">
			, orderreason = #{orderreason}
		</if>
		<if test="orderamount != null">
			, orderamount = #{orderamount}
		</if>
		<if test="mileage != null">
			, mileage = #{mileage}
		</if>
		<if test="starttime != null">
			, starttime = #{starttime}
		</if>
		<if test="endtime != null">
			, endtime = #{endtime}
		</if>
		<if test="pricecopy != null">
			, pricecopy = #{pricecopy}
		</if>
		<if test="shouldpayamount != null">
			, shouldpayamount = #{shouldpayamount}
		</if>
		<if test="actualpayamount != null">
			, actualpayamount = #{actualpayamount}
		</if>
        <if test="belongleasecompany != null">
            , belongleasecompany = #{belongleasecompany}
        </if>
		where orderno=#{orderno}
	</update>
	
	<!-- 添加订单复核记录 -->
	<insert id="applyOpOrderReview" parameterType="OpOrderReview">
		insert into op_orderreview
		(id, orderno, price, mileage, times, starttime, endtime, counttimes, timesubsidies, mileageprices, reviewperson,
		reason, reviewtime, operator, createtime, updatetime, status, rawstarttime, rawendtime, rawtimes, rawmileage, reviewedprice,
		opinion, raworderamount, pricecopy, rawpricecopy, reviewtype)
		values
		(#{id}, #{orderno}, #{price}, #{mileage}, #{times}, #{starttime}, #{endtime}, #{counttimes}, #{timesubsidies}, #{mileageprices},
		#{reviewperson}, #{reason}, now(), #{operator}, now(), now(), '1', #{rawstarttime}, #{rawendtime}, #{rawtimes}, #{rawmileage},
		#{reviewedprice}, #{opinion}, #{raworderamount}, #{pricecopy}, #{rawpricecopy}, #{reviewtype})
	</insert>
	
	<!-- 添加退款记录 -->
	<insert id="insertPeUserRefund" parameterType="PeUserRefund">
		insert into pe_userrefund(id, userid, orderno, committime, confirmtime, amount, refundstatus, remark, createtime, updatetime, creater, updater, status)
		values(#{id}, #{userId}, #{orderNo}, now(), now(), #{amount}, #{refundStatus}, #{remark}, now(), now(), #{creater}, #{updater}, #{status})
	</insert>
	
	<!-- 修改司机状态 -->
	<update id="updatePubDriverWorkstatus" parameterType="PubDriver">
		update pub_driver set workstatus = #{workStatus} where id = #{id}
	</update>
	
	<!-- 查询最原始订单数据 -->
	<select id="getFirstOrderByOrderno" parameterType="string" resultType="map">
		select
		op_orderreview.*,
		ifnull((select reviewedprice from op_orderreview where orderno = #{orderno} and status = 1 order by createtime desc limit 1), 0) recheckprice,
		(select pricecopy from op_order where orderno = #{orderno}) pricecopy
		from op_orderreview where orderno = #{orderno} order by createtime asc limit 1
	</select>
	
	<!-- 添加司机消息 -->
	<insert id="insertPubDriverNews" parameterType="PubDriverNews">
		insert into pub_drivernews(id, driverid, type, title, content, newsstate, createtime, updatetime, status)
		values(#{id}, #{driverid}, #{type}, #{title}, #{content}, #{newsstate}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 订单号联想框(select2) -->
	<select id="getOrdernoBySelect" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno id, op_order.orderno text
		from
			op_order
		where
			op_order.status = 1
			
			<if test='null != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='type == "1"'>
				and op_order.orderstatus = "1"
				<include refid="getOrderCitySQL"></include>
			</if>
			
			<if test='type == "2"'>
				and op_order.orderstatus in ('2', '3', '4', '5', '6')
				<include refid="getOrderCitySQL"></include>
			</if>
			
			<if test='type == "3"'>
				and op_order.reviewstatus = "1"
				<include refid="getOrderLeaseSQL"></include>
			</if>
			
			<if test='type == "4"'>
				and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
				<include refid="getOrderLeaseSQL"></include>
			</if>
			
			<if test='type == "5"'>
				and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
				or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
				<include refid="getOrderLeaseSQL"></include>)
				or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
				<include refid="getOrderCitySQL"></include>))
			</if>
			
			<if test='type == "6"'>
				and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
				<include refid="getOrderLeaseSQL"></include>
			</if>
	</select>
	
	<!-- 根据订单号查询订单的车辆相关信息 -->
	<select id="getOpOrderVehicleByOrder" resultType="map" parameterType="string">
		select
			(select op_vehiclemodels.name from op_vehiclemodels where op_order.factmodel = op_vehiclemodels.id) factmodelname,
			(select op_vehiclemodels.name from op_vehiclemodels where op_order.pricemodel = op_vehiclemodels.id) pricemodelname,
			pub_vehcbrand.name vehcbrandname, pub_vehcline.name vehclinename,
			concat((select text from pub_dictionary where type = '车牌省' and value = pub_vehicle.platenoprovince),
			(select text from pub_dictionary where type = '车牌市' and value = pub_vehicle.platenocity), pub_vehicle.plateno) plateno
		from
			op_order left join pub_vehicle on op_order.vehicleid = pub_vehicle.id
			left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
			left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
		where
			op_order.orderno = #{orderno}
	</select>
	
	<!-- 更新订单的车辆相关信息 -->
	<update id="updateOpOrderVehicleByOrderno" parameterType="OpOrder">
		update op_order set factmodelname = #{factmodelname}, pricemodelname = #{pricemodelname},
		vehcbrandname = #{vehcbrandname}, vehclinename = #{vehclinename}, plateno = #{plateno} ,
		belongleasecompany = #{belongleasecompany}
		where orderno = #{orderno}
	</update>
	
	<!-- 查询客服备注列表 -->
	<select id="getOpOrderCommentListByQuery" resultType="map" parameterType="OrdercommentQueryParam">
		select
			op_ordercomment.id, op_ordercomment.remark, op_ordercomment.operator, op_ordercomment.remarktype,
			date_format(op_ordercomment.createtime, '%Y.%m.%d %H:%i') createtime,
			op_rolemanagement.rolename, op_user.nickname, op_user.usertype
		from
			op_ordercomment left join op_roleuser on op_ordercomment.operator = op_roleuser.userid
			left join op_rolemanagement on op_roleuser.roleid = op_rolemanagement.id
			left join op_user on op_ordercomment.operator = op_user.id
		where
			op_ordercomment.orderno = #{orderno} and op_ordercomment.status = 1
		order by op_ordercomment.createtime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpOrderCommentCountByQuery" resultType="int" parameterType="OrdercommentQueryParam">
		select
			count(*)
		from
			op_ordercomment
		where
			op_ordercomment.orderno = #{orderno} and op_ordercomment.status = 1
	</select>
	
	<!-- 添加客服备注 -->
	<select id="insertOpOrdercomment" parameterType="OpOrdercomment">
		insert into op_ordercomment(id, orderno, remarktype, remark, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{remarktype}, #{remark}, #{operator}, now(), now(), 1)
	</select>
	
	<!-- 查询加入toC的租赁公司和运管平台(select2) -->
	<select id="getToCCompanySelect" resultType="map" parameterType="map">
        select * from (
        select id, `text` from pub_dictionary where type='租赁公司' and status = '1'
        union
        select '运管平台' id, '运管平台' `text`
        ) t where 1=1
        <if test='null != shortname'>
            and text like concat('%', #{shortname}, '%')
        </if>
        order by text asc
        <!--select-->
			<!--id, shortname text-->
		<!--from-->
			<!--le_leasescompany-->
		<!--where-->
			<!--tocstate = "2" and ((status = 1 and platformtype = 1) or (status = 2 and platformtype = 0))-->
			<!--<if test='null != shortname'>-->
				<!--and shortname like concat('%', #{shortname}, '%')-->
			<!--</if>-->
			<!--order by-->
				<!--platformtype desc-->
	</select>
	
	<!-- 查询最近一次的订单复核记录 -->
	<select id="getOpOrderreviewLastByOrderno" parameterType="string" resultType="OpOrderReview">
		select * from op_orderreview where orderno = #{orderno} order by createtime desc limit 1
	</select>
	
	<update id="orderReject" parameterType="OpOrder">
		update op_order set updatetime = now(), reviewstatus = #{reviewstatus} where orderno = #{orderno}
	</update>

    <!-- 修改司机状态为空闲 -->
    <update id="updatePubDriverLeisure" parameterType="string">
        update pub_driver set workstatus = "0", updatetime = now() where id = #{driverid}
    </update>

    <!-- 获取订单列表中的服务车企(select2) -->
    <select id="getBelongCompanySelect" resultType="map" parameterType="OrderManageQueryParam">
        select id, shortname text from le_leasescompany
        where id in
          (select belongleasecompany from op_order left join op_ordercancel on op_order.orderno = op_ordercancel.orderno
            where op_order.status = 1
                <if test='"2" == type'>
                    and op_order.orderstatus in ('2', '3', '4', '5', '6')
                    <include refid="getOrderCitySQL"></include>
                </if>
                <if test='"3" == type'>
                    and op_order.reviewstatus = "1"
                    <include refid="getOrderLeaseSQL"></include>
                </if>
                <if test='"5" == type'>
                    and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
                    and op_order.paymentstatus = "0"
                    <include refid="getOrderLeaseSQL"></include>
                </if>
                <if test='"6" == type'>
                    and op_order.status = 1 and (op_order.orderstatus = "7" or (op_order.orderstatus = "8" and op_ordercancel.cancelnature = 1))
                    and op_order.paymentstatus in ("1", "9")
                    <include refid="getOrderLeaseSQL"></include>
                </if>
                <if test='"7" == type'>
                    and op_order.status = 1 and op_order.orderstatus = "8"
                    and ((not isnull(op_order.companyid) and op_order.companyid != "" <include refid="getOrderLeaseSQL"></include>)
                    or ((isnull(op_order.companyid) or op_order.companyid = "") <include refid="getOrderCitySQL"></include>))
                </if>
            group by op_order.belongleasecompany
          )
    </select>

    <!-- ======================================订单服务结束使用START====================================  -->

    <!-- 查询订单详情 -->
    <select id="getOpOrderInfoByOrderno" parameterType="string" resultType="OrderInfoDetail">
        select
			1 orderprop, pe_user.nickname username, pe_user.account userphone, 0 paymethod, op_platforminfo.servcietel contact,
			op_vehiclemodels.name cartype, op_vehiclemodels.logo cartypelogo, null organid,
			timestampdiff(second, op_order.starttime, op_order.endtime) times, pe_user.headportraitmin passengericonmin,
			pe_user.headportraitmax passengericonmax, pub_cityaddr.city city, op_order.isusenow, op_order.ordersource, op_order.pricecopy,
			op_order.undertime, op_order.ordertime, op_order.departuretime, op_order.arrivaltime, op_order.starttime, op_order.endtime,
			op_order.completetime, op_order.canceltime, op_order.mileage, op_order.orderno, op_order.ordertype type, op_order.onaddress,
			op_order.offaddress, op_order.usetime usetime, op_order.tripremark remark, op_order.orderstatus status, op_order.paymentstatus paystatus,
			op_order.reviewstatus, op_order.onaddrlng onlng, op_order.onaddrlat onlat, op_order.offaddrlng offlng, op_order.offaddrlat offlat,
			op_order.passengers passengers, op_order.passengerphone passengerphone, op_order.estimatedtime, op_order.estimatedmileage,
			op_order.estimatedcost, op_order.orderamount, op_order.fltno, op_order.falltime, op_order.userrate, op_order.usercomment,
			op_order.driverid, op_order.vehicleid, op_order.companyid, op_order.oncity cityid, op_order.usetype
		from
			op_order left join op_vehiclemodels on op_vehiclemodels.status = 1 and op_order.pricemodel = op_vehiclemodels.id
            left join pub_cityaddr on pub_cityaddr.status = 1 and op_order.oncity = pub_cityaddr.id
            left join pe_user on pe_user.status = 1 and op_order.userid = pe_user.id
            left join op_platforminfo on op_platforminfo.status = 1
		where op_order.status = 1 and op_order.orderno = #{orderno}
    </select>

    <!-- 更新订单信息 -->
    <update id="updateOpOrderInfo" parameterType="OrderInfoDetail">
        update op_order set updatetime = now(), orderstatus = #{status}, endcity = #{cityintime}, endaddress = #{addressintime},
        endlng = #{lng}, endllat = #{lat}
        where orderno = #{orderno}
    </update>

    <!-- 查询城市id -->
    <select id="getPubCityByName" parameterType="string" resultType="PubCityAddr">
        select * from pub_cityaddr where city = #{cityname} and status = 1
    </select>

    <!-- 更新司机信息 -->
    <update id="updatePubDriver" parameterType="PubDriver">
        update pub_driver set updatetime = now(), ordercount = #{orderCount}, workStatus = #{workStatus} where id = #{id}
    </update>

    <!-- ======================================订单服务结束使用END====================================  -->
	
</mapper>