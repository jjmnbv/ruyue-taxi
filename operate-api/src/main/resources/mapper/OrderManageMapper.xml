<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.szyciov.operate.mapper.OrderManageMapper">
	<select id="getPubDriver" parameterType="String" resultType="PubDriver">
	SELECT * FROM pub_driver where status = 1 AND id = #{id}
	</select>
	<!-- 分页查询订单数据 -->
	<sql id="getOrderCitySQL">
		<if test='usertype == "0"'>
			and (op_order.oncity in
			(select le_accountrules.city
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 1
			left join le_accountrules on le_leasescompany.id = le_accountrules.leasescompanyid and le_accountrules.type = '0' and le_accountrules.rulesstate = '0'
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_accountrules.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			or
			op_order.oncity in (select op_accountrules.city from op_accountrules where exists
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 0
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			and op_accountrules.rulesstate = "0" and op_accountrules.status = 1))
		</if>
	</sql>
	<sql id="getOrderLeaseSQL">
		<if test='usertype == "0"'>
			and op_order.companyid in
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id
			where op_roleuser.status = 1 and op_roledataauthority.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
		</if>
	</sql>
	
	<!-- 待人工派单 -->
	<select id="getOpLabourOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone,
			date_format(op_order.undertime, '%Y/%m/%d %H:%i') undertime,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			op_order.pushnumber, op_order.orderstatus,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress
		from
			op_order left join pe_user on op_order.userid = pe_user.id
		where
			op_order.status = 1 and op_order.orderstatus in ("0", "1")
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<include refid="getOrderCitySQL"></include>
		order by
			op_order.createtime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpLabourOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.orderstatus in ("0", "1")
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<include refid="getOrderCitySQL"></include>
	</select>
	
	<!-- 当前订单 -->
	<select id="getOpCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.userid, pe_user.nickname, pe_user.account,
			op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
            <!-- le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != orderstatus and "" != orderstatus'>
				and op_order.orderstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
            <if test='null != belongleasecompany and "" != belongleasecompany'>
                <if test='"运管平台" == belongleasecompany'>
                    and ifnull(op_order.belongleasecompany, '') = ''
                </if>
                <if test='"运管平台" != belongleasecompany'>
                    and op_order.belongleasecompany = #{belongleasecompany}
                </if>
            </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderCitySQL"></include>
		order by
			op_order.orderstatus asc,
			case when op_order.orderstatus = '2' then op_order.usetime else '' end asc,
			case when op_order.orderstatus != '2' then op_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != orderstatus and "" != orderstatus'>
				and op_order.orderstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderCitySQL"></include>
	</select>

	<!-- 待复核订单 -->
	<select id="getOpAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson,
			op_order.orderamount, op_order.mileage, op_order.pricecopy,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress,
            <!-- le_leasescompany.shortname, -->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.shouldpayamount,
			ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.times reviewtimes, tmp.counttimes reviewcounttimes, tmp.id reviewid
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.reviewstatus = "1"
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.reviewstatus = "1"
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderLeaseSQL"></include>
	</select>
	
	<!-- 已复核订单 -->
	<select id="getOpWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson, op_order.orderamount, op_order.mileage,
        case when rawtmp.pricecopy is null or rawtmp.pricecopy = '' then op_order.pricecopy else rawtmp.pricecopy end pricecopy,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			<!-- le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.originalorderamount, op_order.shouldpayamount, op_order.actualpayamount,
			tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes,
			rawtmp.rawtimes, rawtmp.rawstarttime, rawtmp.rawendtime, rawtmp.rawmileage, tmp.id reviewid, tmp.rawpricecopy
		from
			op_order left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
			left join (select * from (select * from op_orderreview order by createtime asc) review group by orderno) rawtmp on op_order.orderno = rawtmp.orderno
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<include refid="getOrderLeaseSQL"></include>
	</select>
	
	<!-- 已完成订单 -->
	<select id="getOpCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.paymentstatus, op_order.paytype,
			op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.factmodelname,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress, op_order.cancelparty, op_order.reviewstatus, op_orderpaymentrecord.tradeno,
            <!-- le_leasescompany.shortname, -->
            case when op_order.driverid='' or op_order.driverid is null then '/'
            else ifnull(pub_dictionary.text, '运管平台')
            end shortname,
			op_order.factmodelname, op_order.shouldpayamount, pub_driver.jobnum, op_order.plateno, op_order.estimatedtime, op_order.estimatedmileage,
			date_format(op_order.undertime, '%Y-%m-%d %H:%i') undertime,
			date_format(op_order.ordertime, '%Y-%m-%d %H:%i') ordertime,
			op_order.factmodelname, ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
			left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
			left join pub_driver on op_order.driverid = pub_driver.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
			or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
			<include refid="getOrderLeaseSQL"></include>)
			or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
			<include refid="getOrderCitySQL"></include>))
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='orderstatus == "8"'>
				and op_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and op_order.paymentstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != cancelparty and "" != cancelparty'>
				and op_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<if test='null != tradeno and "" != tradeno'>
				 and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
		order by
			op_order.usetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
		where
			op_order.status = 1 and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
			or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
			<include refid="getOrderLeaseSQL"></include>)
			or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
			<include refid="getOrderCitySQL"></include>))
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='orderstatus == "8"'>
				and op_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and op_order.paymentstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != cancelparty and "" != cancelparty'>
				and op_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<if test='null != tradeno and "" != tradeno'>
				 and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
	</select>
	
	<!-- 待收款订单 -->
	<select id="getOpWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.reviewstatus,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress,
            <!--      le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.shouldpayamount,
                ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid
            from
                op_order left join pe_user on op_order.userid = pe_user.id
                left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
                left join le_leasescompany on op_order.companyid = le_leasescompany.id
                left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
            where
                op_order.status = 1 and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
                <if test='null != orderNo and "" != orderNo'>
                    and op_order.orderno like concat('%', #{orderNo}, '%')
                </if>
                <if test='null != orderType and "" != orderType'>
                    and op_order.ordertype = #{orderType}
                </if>
                <if test='null != userId and "" != userId'>
                    and op_order.userid = #{userId}
                </if>
                <if test='null != driverid and "" != driverid'>
                    and op_order.driverid = #{driverid}
                </if>
                <if test='null != ordersource and "" != ordersource'>
                    and op_order.orderno like concat(#{ordersource}, '%')
                </if>
                <if test='null != leasescompanyid and "" != leasescompanyid'>
                    and op_order.companyid = #{leasescompanyid}
                </if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
                <if test='null != minUseTime and "" != minUseTime'>
                    <![CDATA[
                        and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <if test='null != maxUseTime and "" != maxUseTime'>
                    <![CDATA[
                        and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <include refid="getOrderLeaseSQL"></include>
            order by
                op_order.usetime desc
            limit #{iDisplayStart}, #{iDisplayLength}
        </select>
        <select id="getOpWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
            select
                count(*)
            from
                op_order
            where
                op_order.status = 1 and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
                <if test='null != orderNo and "" != orderNo'>
                    and op_order.orderno like concat('%', #{orderNo}, '%')
                </if>
                <if test='null != orderType and "" != orderType'>
                    and op_order.ordertype = #{orderType}
                </if>
                <if test='null != userId and "" != userId'>
                    and op_order.userid = #{userId}
                </if>
                <if test='null != driverid and "" != driverid'>
                    and op_order.driverid = #{driverid}
                </if>
                <if test='null != ordersource and "" != ordersource'>
                    and op_order.orderno like concat(#{ordersource}, '%')
                </if>
                <if test='null != leasescompanyid and "" != leasescompanyid'>
                    and op_order.companyid = #{leasescompanyid}
                </if>
            <if test='null != belongleasecompany and "" != belongleasecompany'>
                <if test='"运管平台" == belongleasecompany'>
                    and ifnull(op_order.belongleasecompany, '') = ''
                </if>
                <if test='"运管平台" != belongleasecompany'>
                    and op_order.belongleasecompany = #{belongleasecompany}
                </if>
            </if>
                <if test='null != minUseTime and "" != minUseTime'>
                    <![CDATA[
                        and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <if test='null != maxUseTime and "" != maxUseTime'>
                    <![CDATA[
                        and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <include refid="getOrderLeaseSQL"></include>
        </select>

        <!-- 查询派单规则中所有城市 -->
	<select id="getSendRulesByName" parameterType="string" resultType="map">
		select
            pub_sendrules.city id, pub_cityaddr.city text
		from
            pub_sendrules, pub_cityaddr
		where
            pub_sendrules.city = pub_cityaddr.id
			and pub_sendrules.status = 1
            and pub_sendrules.platformtype = "0"
            and pub_sendrules.vehicletype = 0
			and pub_cityaddr.status = 1
			<if test='null != _parameter and "" != _parameter'>
				and pub_cityaddr.city like concat("%", #{_parameter}, "%")
			</if>
	</select>
	
	<!-- 查询下单人列表信息 -->
	<select id="getPeUser" resultType="map" parameterType="string">
		select id, if(isnull(nickname) || nickname = '', account, concat(nickname, " ", account)) text
		from pe_user
		where disablestate = '0' and status = 1
		<if test='null != _parameter and "" != _parameter'>
			and (account like concat("%", #{_parameter}, "%") or nickname like concat("%", #{_parameter}, "%"))
		</if>
	</select>
	
	<!-- 查询订单详情 -->
	<select id="getOpOrderByOrderno" resultType="map" parameterType="string">
		select 
			a.*, b.nickname, b.account, d.name drivername, d.phone driverphone,
			(select city from pub_cityaddr where pub_cityaddr.id = a.oncity) oncityName, 
			(select city from pub_cityaddr where pub_cityaddr.id = a.offcity) offcityName,
			ifnull(tmp.price, 0) price, tmp.starttime reviewstarttime, tmp.endtime reviewendtime, tmp.times reviewtimes, tmp.counttimes reviewcounttimes,
			tmp.mileage reviewmileage, tmp.timesubsidies reviewtimesubsidies, tmp.mileageprices reviewmileageprices,
			case when a.driverid is null or a.driverid = '' then '/' else ifnull(pub_dictionary.text, '运管平台') end belongleasecompanytext
		from op_order a left join pe_user b on a.userid = b.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp
				on a.orderno = tmp.orderno
			left join pub_driver d on a.driverid = d.id
			left join pub_dictionary on pub_dictionary.id = a.belongleasecompany
		where a.status = 1 and a.orderno = #{orderno} limit 1
	</select>
	
	<!-- 取消订单 -->
	<update id="cancelOpOrder" parameterType="string">
		update op_order set orderstatus = '8', cancelparty = '0', updatetime = now(), canceltime = now() where orderno = #{orderno}
	</update>
	
	<!-- 查询订单详情 -->
	<select id="getOpOrder" parameterType="string" resultType="OpOrder">
		select * from op_order where status = 1 and orderno = #{orderno}
	</select>
	
	<!-- 根据上车城市查询车型信息 -->
	<select id="getCompanyVehicleModel" parameterType="string" resultType="map">
		select
			op_vehiclemodels.id, op_vehiclemodels.name
		from
			op_accountrules left join op_vehiclemodels on op_accountrules.vehiclemodelsid = op_vehiclemodels.id,
			(select oncity, ordertype from op_order where orderno = #{orderno}) temp
		where
			op_accountrules.rulesstate = "0" and op_accountrules.status = 1
			and op_vehiclemodels.modelstatus = "0" and op_vehiclemodels.status = 1
			and op_accountrules.city = temp.oncity and op_accountrules.rulestype = temp.ordertype
	</select>
	
	<!-- 根据上车城市查询派单规则 -->
	<select id="getSendRulesList" parameterType="PubSendRules" resultType="PubSendRules">
		select * from pub_sendrules
		where status = 1 and pub_sendrules.platformtype = "0" and pub_sendrules.vehicletype = 0
		<if test='null != city and "" != city'>
			and city = #{city}
		</if>
        <if test='null != useType'>
            and usetype = #{useType}
        </if>
	</select>
	
	<!-- 分页查询司机信息 -->
	<sql id="getDriverSQL">
		<if test="driverid != null and driverid != ''">
			and pub_driver.id != #{driverid}
		</if>
		<if test="oncity != null and oncity != ''">
			and (pub_vehicle_scope.cityid = #{oncity}
			<if test="offcity != null and offcity != ''">
				or pub_vehicle_scope.cityid = #{offcity}
			</if>
			)
		</if> 
		<if test="driverState != null and driverState != ''">
			and pub_driver.workstatus = #{driverState}
		</if>
		<if test="selectedmodel != null and selectedmodel != ''">
			and op_vehiclemodels.id = #{selectedmodel}
		</if>
		<if test="minLat != null and minLat != '' and maxLat != null and maxLat != ''">
		<![CDATA[
			and pub_driver.lat >= ${minLat} and pub_driver.lat <= ${maxLat}
		]]>
		</if>
		<if test="minLon != null and minLon != '' and maxLon != null and maxLon != ''">
		<![CDATA[
			and pub_driver.lng >= ${minLon} and pub_driver.lng <= ${maxLon}
		]]>
		</if>
		<if test="driverName != null and driverName != ''">
			and pub_driver.name like "%"#{driverName}"%"
		</if>
		<if test="models == 1">
			and op_vehiclemodels.level >= (select level from op_vehiclemodels where id = #{orderSelectedmodel})
		</if>
		<if test="models == 0">
			and op_vehiclemodels.id = #{orderSelectedmodel}
		</if>
        <if test='null != queryTmpBelongleasecompany and "" != queryTmpBelongleasecompany'>
            and pub_driver.belongleasecompany = #{queryTmpBelongleasecompany}
        </if>
		and pub_driver.lng &gt; 0 and pub_driver.lat &gt; 0
		and pub_driver.vehicletype = "0"
		and op_vehiclemodels.id in (
			select
				op_vehiclemodels.id
			from
				op_accountrules left join op_vehiclemodels on op_accountrules.vehiclemodelsid = op_vehiclemodels.id,
				(select oncity, ordertype from op_order where orderno = #{orderNo}) temp
			where
				op_accountrules.rulesstate = "0" and op_accountrules.status = 1
				and op_vehiclemodels.modelstatus = "0" and op_vehiclemodels.status = 1
				and op_accountrules.city = temp.oncity and op_accountrules.rulestype = temp.ordertype
		)
		and pub_driver.phone not in (select account from pe_user where pe_user.id = #{userId} and pe_user.status = 1)
		group by pub_driver.id
	</sql>
	<select id="getDriverListByQuery" parameterType="OrderManageQueryParam" resultType="map">
		select
			*
		from
			(select
				pub_driver.id driverid, pub_driver.name drivername, pub_driver.workstatus, pub_driver.lat, pub_driver.lng,
				pub_driver.phone, pub_driver.headportraitmin, pub_driver.headportraitmax, op_vehiclemodels.id modelsid,
				op_vehiclemodels.name modelname, pub_driver.leasescompanyid, pub_vehicle.id vehicleid,
				concat(pub_vehcbrand.name, " ", pub_vehcline.name) brandname,
				concat(
					(select pub_dictionary.text from pub_dictionary where pub_vehicle.platenoprovince = pub_dictionary.value and pub_dictionary.type = "车牌省"),
					(select pub_dictionary.text from pub_dictionary where pub_vehicle.platenocity = pub_dictionary.value and pub_dictionary.type = "车牌市"),
					pub_vehicle.plateno
				) plateno
			from
				pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
				left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
				left join op_vehiclemodels_vehicle_ref on pub_vehicle.id = op_vehiclemodels_vehicle_ref.vehicleid
				left join op_vehiclemodels on op_vehiclemodels_vehicle_ref.vehiclemodelsid = op_vehiclemodels.id
				left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
				left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
				left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
			where
				pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and op_vehiclemodels_vehicle_ref.status = 1
				and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1 and pub_vehcline.status = 1 and pub_vehcbrand.status = 1
				and pub_driver.workstatus in ("0", "2") and pub_driver.platformtype = "1"
				<include refid="getDriverSQL"></include>
			
			union
			
			select
				pub_driver.id driverid, pub_driver.name drivername, pub_driver.workstatus, pub_driver.lat, pub_driver.lng,
				pub_driver.phone, pub_driver.headportraitmin, pub_driver.headportraitmax, op_vehiclemodels.id modelsid,
				op_vehiclemodels.name modelname, pub_driver.leasescompanyid, pub_vehicle.id vehicleid,
				concat(pub_vehcbrand.name, " ", pub_vehcline.name) brandname,
				concat(
					(select pub_dictionary.text from pub_dictionary where pub_vehicle.platenoprovince = pub_dictionary.value and pub_dictionary.type = "车牌省"),
					(select pub_dictionary.text from pub_dictionary where pub_vehicle.platenocity = pub_dictionary.value and pub_dictionary.type = "车牌市"),
					pub_vehicle.plateno
				) plateno
			from
				pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
				left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
				left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
				left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
				left join op_vehcline_models_ref on pub_vehcline.id = op_vehcline_models_ref.vehclineid
				left join op_vehiclemodels on op_vehcline_models_ref.vehiclemodelsid = op_vehiclemodels.id
				left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
			where
				pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and pub_vehcbrand.status = 1
				and op_vehcline_models_ref.status = 1 and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1
				and pub_driver.workstatus in ("0", "2") and pub_driver.platformtype = "0"
				<include refid="getDriverSQL"></include>) driverTmp
			limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getDriverCountByQuery" parameterType="OrderManageQueryParam" resultType="int">
		select
			count(*)
		from
			(select
				pub_driver.id
			from
				pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
				left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
				left join op_vehiclemodels_vehicle_ref on pub_vehicle.id = op_vehiclemodels_vehicle_ref.vehicleid
				left join op_vehiclemodels on op_vehiclemodels_vehicle_ref.vehiclemodelsid = op_vehiclemodels.id
				left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
				left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
				left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
			where
				pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and op_vehiclemodels_vehicle_ref.status = 1
				and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1 and pub_vehcline.status = 1 and pub_vehcbrand.status = 1
				and pub_driver.workstatus in ("0", "2") and pub_driver.platformtype = "1"
				<include refid="getDriverSQL"></include>
			
			union
			
			select
				pub_driver.id
			from
				pub_driver left join pub_driver_vehicle_ref on pub_driver.id = pub_driver_vehicle_ref.driverid
				left join pub_vehicle on pub_driver_vehicle_ref.vehicleid = pub_vehicle.id
				left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
				left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
				left join op_vehcline_models_ref on pub_vehcline.id = op_vehcline_models_ref.vehclineid
				left join op_vehiclemodels on op_vehcline_models_ref.vehiclemodelsid = op_vehiclemodels.id
				left join pub_vehicle_scope on pub_vehicle.id = pub_vehicle_scope.vehicleid
			where
				pub_driver.status = 1 and pub_driver_vehicle_ref.status = 1 and pub_vehicle.status = 1 and pub_vehcbrand.status = 1
				and op_vehcline_models_ref.status = 1 and op_vehiclemodels.status = 1 and pub_vehicle_scope.status = 1
				and pub_driver.workstatus in ("0", "2") and pub_driver.platformtype = "0"
				<include refid="getDriverSQL"></include>) driverTmp
	</select>
	
	<!-- 根据车型查询计费规则 -->
	<select id="findModelPriceByModels" parameterType="map" resultType="OpAccountrules">
		select * from op_accountrules
		where city = #{city} 
		and vehiclemodelsid = #{cartype} 
		and rulestype = #{rulestype} 
		and rulesstate = 0 
		and status = 1
	</select>
	
	<!-- 人工派单修改订单数据 -->
	<update id="manualSendOrder" parameterType="OpOrder">
		update op_order set driverid=#{driverid}, companyid = #{companyid}, orderstatus='2', pricemodel = #{pricemodel}, factmodel = #{factmodel},
		pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), ordertime = now(), isusenow = #{isusenow}
		where orderno=#{orderno}
	</update>
	
	<!-- 添加人工派单记录 -->
	<insert id="insertOpSendrecord" parameterType="OpSendrecord">
		insert into op_sendrecord(id, orderno, driverid, operator, chargemodel, reason, sendtime, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{driverid}, #{operator}, #{chargemodel}, #{reason}, now(), now(), now(), 1)
	</insert>
	
	<!-- 更换司机修改订单数据 -->
	<update id="changeOpDriver" parameterType="map">
		update op_order set updatetime=#{updatetime}, companyid = #{companyid}, driverid = #{newdriverid}, pricemodel = #{pricemodel},
		factmodel = #{factmodel}, pricecopy = #{pricecopy}, vehicleid = #{vehicleid}, updatetime = now(), orderstatus = "2", ordertime = now(),
		isusenow = #{isusenow}
		where orderno=#{orderno}
	</update>
	
	<!-- 添加更换司机记录 -->
	<insert id="insertOpDriverchanges" parameterType="OpDriverchanges">
		insert into op_driverchanges(id, orderno, beforedriverid, afterdriverid, chargemodel, reason, sendtime, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{beforedriverid}, #{afterdriverid}, #{chargemodel}, #{reason}, #{sendtime}, #{operator}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 复核订单修改订单数据 -->
	<update id="applyRecheckOrder" parameterType="map">
		update op_order set updatetime=now(),  orderreason = #{orderreason}, reviewperson = #{reviewperson}, reviewstatus = #{reviewstatus}
		where orderno=#{orderno}
	</update>
	
	<!-- 查询订单的人工派单记录 -->
	<select id="getOpSendOrderRecord" resultType="map" parameterType="string">
		select id, orderno, driverid, reason, operator, date_format(createtime, '%Y-%m-%d %H:%i') createtime, updatetime, status, 
		(select t1.nickname from op_user t1 where t.operator = t1.id) operatorname,
		(select CONCAT(t1.name,' ', t1.phone) from pub_driver t1 where t.driverid = t1.id) driverinfo
		from op_sendrecord t
		where orderno = #{orderno} and status = 1 limit 1
	</select>
	
	<!-- 查询订单更换司机记录 -->
	<select id="getOpChangeDriverListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*, (select CONCAT(t1.name, ' ', t1.phone) from pub_driver t1 where t1.id = t.beforedriverid) beforedriverinfo,  
		(select CONCAT(t1.name, ' ', t1.phone) from pub_driver t1 where t1.id = t.afterdriverid) afterdriverinfo,
		(select t1.nickname from op_user t1 where t.operator = t1.id) operatorname,
		date_format(t.sendtime, '%Y/%m/%d %H:%i') changetime
		from op_driverchanges t, (select @rownum :=0) b
		where orderno = #{orderNo} and status = 1 order by createtime desc
	</select>
	<select id="getOpChangeDriverCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from op_driverchanges where orderno = #{orderNo} and status = 1
	</select>
	
	<!-- 查询订单的复核记录 -->
	<select id="getOpOrderReviewListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select (@rownum := @rownum + 1) rownum, t.*, (select t1.nickname from op_user t1 where t1.id = t.operator) operatorname,
		(select pricecopy from op_order where orderno = #{orderNo}) pricecopy
		from op_orderreview t, (select @rownum :=0) b where orderno = #{orderNo} and status = 1
		order by reviewtime desc
	</select>
	<select id="getOpOrderReviewCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select count(*) from op_orderreview where orderno = #{orderNo} and status = 1
	</select>
	
	<!-- 修改订单数据 -->
	<update id="updateOrderState"  parameterType="OpOrder">
		update op_order set updateTime=now() 
		
		<if test="orderstatus != null">
			, orderstatus = #{orderstatus} 
		</if>
		
		<if test="reviewstatus != null">
			, reviewstatus = #{reviewstatus} 
		</if>
		
		<if test="paymentstatus != null">
			, paymentstatus = #{paymentstatus} 
		</if>
		
		<if test="orderreason != null">
			, orderreason = #{orderreason}
		</if>
		<if test="orderamount != null">
			, orderamount = #{orderamount}
		</if>
		<if test="mileage != null">
			, mileage = #{mileage}
		</if>
		<if test="starttime != null">
			, starttime = #{starttime}
		</if>
		<if test="endtime != null">
			, endtime = #{endtime}
		</if>
		<if test="pricecopy != null">
			, pricecopy = #{pricecopy}
		</if>
		<if test="shouldpayamount != null">
			, shouldpayamount = #{shouldpayamount}
		</if>
		<if test="actualpayamount != null">
			, actualpayamount = #{actualpayamount}
		</if>
		where orderno=#{orderno}
	</update>
	
	<!-- 添加订单复核记录 -->
	<insert id="applyOpOrderReview" parameterType="OpOrderReview">
		insert into op_orderreview
		(id, orderno, price, mileage, times, starttime, endtime, counttimes, timesubsidies, mileageprices, reviewperson,
		reason, reviewtime, operator, createtime, updatetime, status, rawstarttime, rawendtime, rawtimes, rawmileage, reviewedprice,
		opinion, raworderamount, pricecopy, rawpricecopy)
		values
		(#{id}, #{orderno}, #{price}, #{mileage}, #{times}, #{starttime}, #{endtime}, #{counttimes}, #{timesubsidies}, 
		#{mileageprices}, #{reviewperson}, #{reason}, now(), #{operator}, now(), now(), '1', #{rawstarttime},
		#{rawendtime}, #{rawtimes}, #{rawmileage}, #{reviewedprice}, #{opinion}, #{raworderamount}, #{pricecopy}, #{rawpricecopy})
	</insert>
	
	<!-- 添加退款记录 -->
	<insert id="insertPeUserRefund" parameterType="PeUserRefund">
		insert into pe_userrefund(id, userid, orderno, committime, confirmtime, amount, refundstatus, remark, createtime, updatetime, creater, updater, status)
		values(#{id}, #{userId}, #{orderNo}, now(), now(), #{amount}, #{refundStatus}, #{remark}, now(), now(), #{creater}, #{updater}, #{status})
	</insert>
	
	<!-- 修改司机状态 -->
	<update id="updatePubDriverWorkstatus" parameterType="PubDriver">
		update pub_driver set workstatus = #{workStatus} where id = #{id}
	</update>
	
	<!-- 查询最原始订单数据 -->
	<select id="getFirstOrderByOrderno" parameterType="string" resultType="map">
		select
		op_orderreview.*,
		ifnull((select reviewedprice from op_orderreview where orderno = #{orderno} and status = 1 order by createtime desc limit 1), 0) recheckprice,
		(select pricecopy from op_order where orderno = #{orderno}) pricecopy
		from op_orderreview where orderno = #{orderno} order by createtime asc limit 1
	</select>
	
	<!-- 添加司机消息 -->
	<insert id="insertPubDriverNews" parameterType="PubDriverNews">
		insert into pub_drivernews(id, driverid, type, title, content, newsstate, createtime, updatetime, status)
		values(#{id}, #{driverid}, #{type}, #{title}, #{content}, #{newsstate}, #{createtime}, #{updatetime}, #{status})
	</insert>
	
	<!-- 订单号联想框(select2) -->
	<select id="getOrdernoBySelect" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno id, op_order.orderno text
		from
			op_order
		where
			op_order.status = 1
			
			<if test='null != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			
			<if test='type == "1"'>
				and op_order.orderstatus = "1"
				<include refid="getOrderCitySQL"></include>
			</if>
			
			<if test='type == "2"'>
				and op_order.orderstatus in ('2', '3', '4', '5', '6')
				<include refid="getOrderCitySQL"></include>
			</if>
			
			<if test='type == "3"'>
				and op_order.reviewstatus = "1"
				<include refid="getOrderLeaseSQL"></include>
			</if>
			
			<if test='type == "4"'>
				and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
				<include refid="getOrderLeaseSQL"></include>
			</if>
			
			<if test='type == "5"'>
				and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
				or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
				<include refid="getOrderLeaseSQL"></include>)
				or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
				<include refid="getOrderCitySQL"></include>))
			</if>
			
			<if test='type == "6"'>
				and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
				<include refid="getOrderLeaseSQL"></include>
			</if>
	</select>
	
	<!-- 根据订单号查询订单的车辆相关信息 -->
	<select id="getOpOrderVehicleByOrder" resultType="map" parameterType="string">
		select
			(select op_vehiclemodels.name from op_vehiclemodels where op_order.factmodel = op_vehiclemodels.id) factmodelname,
			(select op_vehiclemodels.name from op_vehiclemodels where op_order.pricemodel = op_vehiclemodels.id) pricemodelname,
			pub_vehcbrand.name vehcbrandname, pub_vehcline.name vehclinename,
			concat((select text from pub_dictionary where type = '车牌省' and value = pub_vehicle.platenoprovince),
			(select text from pub_dictionary where type = '车牌市' and value = pub_vehicle.platenocity), pub_vehicle.plateno) plateno
		from
			op_order left join pub_vehicle on op_order.vehicleid = pub_vehicle.id
			left join pub_vehcline on pub_vehicle.vehclineid = pub_vehcline.id
			left join pub_vehcbrand on pub_vehcline.vehcBrandID = pub_vehcbrand.id
		where
			op_order.orderno = #{orderno}
	</select>
	
	<!-- 更新订单的车辆相关信息 -->
	<update id="updateOpOrderVehicleByOrderno" parameterType="OpOrder">
		update op_order set factmodelname = #{factmodelname}, pricemodelname = #{pricemodelname},
		vehcbrandname = #{vehcbrandname}, vehclinename = #{vehclinename}, plateno = #{plateno} ,
		belongleasecompany = #{belongleasecompany}
		where orderno = #{orderno}
	</update>
	
	<!-- 查询客服备注列表 -->
	<select id="getOpOrderCommentListByQuery" resultType="map" parameterType="OrdercommentQueryParam">
		select
			op_ordercomment.id, op_ordercomment.remark, op_ordercomment.operator, op_ordercomment.remarktype,
			date_format(op_ordercomment.createtime, '%Y.%m.%d %H:%i') createtime,
			op_rolemanagement.rolename, op_user.nickname, op_user.usertype
		from
			op_ordercomment left join op_roleuser on op_ordercomment.operator = op_roleuser.userid
			left join op_rolemanagement on op_roleuser.roleid = op_rolemanagement.id
			left join op_user on op_ordercomment.operator = op_user.id
		where
			op_ordercomment.orderno = #{orderno} and op_ordercomment.status = 1
		order by op_ordercomment.createtime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpOrderCommentCountByQuery" resultType="int" parameterType="OrdercommentQueryParam">
		select
			count(*)
		from
			op_ordercomment
		where
			op_ordercomment.orderno = #{orderno} and op_ordercomment.status = 1
	</select>
	
	<!-- 添加客服备注 -->
	<select id="insertOpOrdercomment" parameterType="OpOrdercomment">
		insert into op_ordercomment(id, orderno, remarktype, remark, operator, createtime, updatetime, status)
		values(#{id}, #{orderno}, #{remarktype}, #{remark}, #{operator}, now(), now(), 1)
	</select>
	
	<!-- 查询加入toC的租赁公司和运管平台(select2) -->
	<select id="getToCCompanySelect" resultType="map" parameterType="map">
        select * from (
        select id, `text` from pub_dictionary where type='租赁公司' and status = '1'
        union
        select '运管平台' id, '运管平台' `text`
        ) t where 1=1
        <if test='null != shortname'>
            and text like concat('%', #{shortname}, '%')
        </if>
        order by text asc
        <!--select-->
			<!--id, shortname text-->
		<!--from-->
			<!--le_leasescompany-->
		<!--where-->
			<!--tocstate = "2" and ((status = 1 and platformtype = 1) or (status = 2 and platformtype = 0))-->
			<!--<if test='null != shortname'>-->
				<!--and shortname like concat('%', #{shortname}, '%')-->
			<!--</if>-->
			<!--order by-->
				<!--platformtype desc-->
	</select>
	
	<!-- 查询最近一次的订单复核记录 -->
	<select id="getOpOrderreviewLastByOrderno" parameterType="string" resultType="OpOrderReview">
		select * from op_orderreview where orderno = #{orderno} order by createtime desc limit 1
	</select>
	
	<update id="orderReject" parameterType="OpOrder">
		update op_order set updatetime = now(), reviewstatus = #{reviewstatus} where orderno = #{orderno}
	</update>

    <!-- 修改司机状态为空闲 -->
    <update id="updatePubDriverLeisure" parameterType="string">
        update pub_driver set workstatus = "0", updatetime = now() where id = #{driverid}
    </update>
	
</mapper>