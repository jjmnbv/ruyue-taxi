<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.szyciov.operate.mapper.TmpOrderManageMapper">
	<!-- 分页查询订单数据 -->
	<sql id="getOrderCitySQL">
		<if test='usertype == "0"'>
			and (op_order.oncity in
			(select le_accountrules.city
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 1
			left join le_accountrules on le_leasescompany.id = le_accountrules.leasescompanyid and le_accountrules.type = '0' and le_accountrules.rulesstate = '0'
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_accountrules.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			or
			op_order.oncity in (select op_accountrules.city from op_accountrules where exists
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id and le_leasescompany.platformtype = 0
			where op_roleuser.status = 1 and op_roledataauthority.status = 1 and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
			and op_accountrules.rulesstate = "0" and op_accountrules.status = 1))
		</if>
	</sql>
	<sql id="getOrderLeaseSQL">
		<if test='usertype == "0"'>
			and op_order.companyid in
			(select le_leasescompany.id
			from op_roleuser left join op_roledataauthority on op_roleuser.roleid = op_roledataauthority.roleid
			left join le_leasescompany on op_roledataauthority.rootdynamicid = le_leasescompany.id
			where op_roleuser.status = 1 and op_roledataauthority.status = 1
			and le_leasescompany.tocstate = 2 and op_roleuser.userid = #{opUserId})
		</if>
	</sql>

	<!-- 当前订单 -->
	<select id="getOpCurrentOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.userid, pe_user.nickname, pe_user.account,
			op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
            <!-- le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != orderstatus and "" != orderstatus'>
				and op_order.orderstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
            <if test='null != belongleasecompany and "" != belongleasecompany'>
                <if test='"运管平台" == belongleasecompany'>
                    and ifnull(op_order.belongleasecompany, '') = ''
                </if>
                <if test='"运管平台" != belongleasecompany'>
                    and op_order.belongleasecompany = #{belongleasecompany}
                </if>
            </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderCitySQL"></include>
		order by
			op_order.orderstatus asc,
			case when op_order.orderstatus = '2' then op_order.usetime else '' end asc,
			case when op_order.orderstatus != '2' then op_order.usetime else '' end desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCurrentOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.orderstatus in ('2', '3', '4', '5', '6')
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != orderstatus and "" != orderstatus'>
				and op_order.orderstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderCitySQL"></include>
	</select>

	<!-- 待复核订单 -->
	<select id="getOpAbnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson,
			op_order.orderamount, op_order.mileage, op_order.pricecopy,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress,
            <!-- le_leasescompany.shortname, -->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.shouldpayamount,
			ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.times reviewtimes, tmp.counttimes reviewcounttimes, tmp.id reviewid
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.reviewstatus = "1"
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime asc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpAbnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.reviewstatus = "1"
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
				]]>
			</if>
			<include refid="getOrderLeaseSQL"></include>
	</select>
	
	<!-- 已复核订单 -->
	<select id="getOpWasabnormalOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.reviewperson, op_order.orderamount, op_order.mileage,
        case when rawtmp.pricecopy is null or rawtmp.pricecopy = '' then op_order.pricecopy else rawtmp.pricecopy end pricecopy,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			<!-- le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.originalorderamount, op_order.shouldpayamount, op_order.actualpayamount,
			tmp.reviewedprice reviewedprice, tmp.mileage reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes,
			rawtmp.rawtimes, rawtmp.rawstarttime, rawtmp.rawendtime, rawtmp.rawmileage, tmp.id reviewid, tmp.rawpricecopy
		from
			op_order left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
			left join (select * from (select * from op_orderreview order by createtime asc) review group by orderno) rawtmp on op_order.orderno = rawtmp.orderno
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<include refid="getOrderLeaseSQL"></include>
		order by
			op_order.updatetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpWasabnormalOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order
		where
			op_order.status = 1 and op_order.reviewstatus = "2" and op_order.paymentstatus in ("0", "1")
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='null != paymentstatus and "" != paymentstatus'>
				and op_order.paymentstatus = #{paymentstatus}
			</if>
			<if test='null != reviewperson and "" != reviewperson'>
				and op_order.reviewperson = #{reviewperson}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<include refid="getOrderLeaseSQL"></include>
	</select>
	
	<!-- 已完成订单 -->
	<select id="getOpCompleteOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.orderstatus, op_order.paymentstatus, op_order.paytype,
			op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.factmodelname,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			concat(pub_driver.name, " ", pub_driver.phone) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress, op_order.cancelparty, op_order.reviewstatus, op_orderpaymentrecord.tradeno,
            <!-- le_leasescompany.shortname, -->
            case when op_order.driverid='' or op_order.driverid is null then '/'
            else ifnull(pub_dictionary.text, '运管平台')
            end shortname,
			op_order.factmodelname, op_order.shouldpayamount, pub_driver.jobnum, op_order.plateno, op_order.estimatedtime, op_order.estimatedmileage,
			date_format(op_order.undertime, '%Y-%m-%d %H:%i') undertime,
			date_format(op_order.ordertime, '%Y-%m-%d %H:%i') ordertime,
			op_order.factmodelname, ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid
		from
			op_order left join pe_user on op_order.userid = pe_user.id
			left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
			left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
			left join le_leasescompany on op_order.companyid = le_leasescompany.id
			left join pub_driver on op_order.driverid = pub_driver.id
            left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
		where
			op_order.status = 1 and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
			or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
			<include refid="getOrderLeaseSQL"></include>)
			or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
			<include refid="getOrderCitySQL"></include>))
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='orderstatus == "8"'>
				and op_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and op_order.paymentstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != cancelparty and "" != cancelparty'>
				and op_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<if test='null != tradeno and "" != tradeno'>
				 and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
		order by
			op_order.usetime desc
		limit #{iDisplayStart}, #{iDisplayLength}
	</select>
	<select id="getOpCompleteOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
		select
			count(*)
		from
			op_order left join op_orderpaymentrecord on op_order.orderno = op_orderpaymentrecord.orderno and not isnull(op_orderpaymentrecord.tradeno)
		where
			op_order.status = 1 and ((((op_order.orderstatus = "7" and op_order.paymentstatus = "1")
			or (op_order.orderstatus = '8' and not isnull(op_order.companyid) and op_order.companyid != ""))
			<include refid="getOrderLeaseSQL"></include>)
			or (op_order.orderstatus = '8' and (isnull(op_order.companyid) or op_order.companyid = "")
			<include refid="getOrderCitySQL"></include>))
            and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
			<if test='null != orderNo and "" != orderNo'>
				and op_order.orderno like concat('%', #{orderNo}, '%')
			</if>
			<if test='null != orderType and "" != orderType'>
				and op_order.ordertype = #{orderType}
			</if>
			<if test='orderstatus == "8"'>
				and op_order.orderstatus = '8'
			</if>
			<if test='null != orderstatus and "" != orderstatus and orderstatus != "8"'>
				and op_order.paymentstatus = #{orderstatus}
			</if>
			<if test='null != userId and "" != userId'>
				and op_order.userid = #{userId}
			</if>
			<if test='null != driverid and "" != driverid'>
				and op_order.driverid = #{driverid}
			</if>
			<if test='null != cancelparty and "" != cancelparty'>
				and op_order.cancelparty = #{cancelparty}
			</if>
			<if test='null != ordersource and "" != ordersource'>
				and op_order.orderno like concat(#{ordersource}, '%')
			</if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
			<if test='null != leasescompanyid and "" != leasescompanyid'>
				and op_order.companyid = #{leasescompanyid}
			</if>
			<if test='null != tradeno and "" != tradeno'>
				 and op_orderpaymentrecord.tradeno like concat('%', #{tradeno} , '%')
			</if>
			<if test='null != minUseTime and "" != minUseTime'>
				<![CDATA[
					and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
			<if test='null != maxUseTime and "" != maxUseTime'>
				<![CDATA[
					and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
	</select>
	
	<!-- 待收款订单 -->
	<select id="getOpWaitgatheringOrderListByQuery" resultType="map" parameterType="OrderManageQueryParam">
		select
			op_order.orderno, op_order.ordertype, op_order.paymentstatus, op_order.orderstatus, op_order.orderamount, op_order.mileage, op_order.pricecopy, op_order.reviewstatus,
			date_format(op_order.starttime, '%Y/%m/%d %H:%i:%s') starttime,
			date_format(op_order.endtime, '%Y/%m/%d %H:%i:%s') endtime,
			op_order.userid, pe_user.nickname, pe_user.account, op_order.passengers, op_order.passengerphone, op_order.driverid,
			(select concat(pub_driver.name, " ", pub_driver.phone) from pub_driver where pub_driver.id = op_order.driverid) drivername,
			date_format(op_order.usetime, '%Y/%m/%d %H:%i') usetime,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.oncity) oncity,
			op_order.oncity, op_order.onaddress,
			(select pub_cityaddr.city from pub_cityaddr where pub_cityaddr.id = op_order.offcity) offcity,
			op_order.offcity, op_order.offaddress,
            <!--      le_leasescompany.shortname,-->
            ifnull(pub_dictionary.text, '运管平台') shortname,
            op_order.shouldpayamount,
                ifnull(tmp.mileage, op_order.mileage) reviewmileage, tmp.counttimes reviewcounttimes, tmp.times reviewtimes, tmp.id reviewid
            from
                op_order left join pe_user on op_order.userid = pe_user.id
                left join (select * from (select * from op_orderreview order by createtime desc) review group by orderno) tmp on op_order.orderno = tmp.orderno
                left join le_leasescompany on op_order.companyid = le_leasescompany.id
                left join pub_dictionary on pub_dictionary.id = op_order.belongleasecompany
            where
                op_order.status = 1 and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
                and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
                <if test='null != orderNo and "" != orderNo'>
                    and op_order.orderno like concat('%', #{orderNo}, '%')
                </if>
                <if test='null != orderType and "" != orderType'>
                    and op_order.ordertype = #{orderType}
                </if>
                <if test='null != userId and "" != userId'>
                    and op_order.userid = #{userId}
                </if>
                <if test='null != driverid and "" != driverid'>
                    and op_order.driverid = #{driverid}
                </if>
                <if test='null != ordersource and "" != ordersource'>
                    and op_order.orderno like concat(#{ordersource}, '%')
                </if>
                <if test='null != leasescompanyid and "" != leasescompanyid'>
                    and op_order.companyid = #{leasescompanyid}
                </if>
        <if test='null != belongleasecompany and "" != belongleasecompany'>
            <if test='"运管平台" == belongleasecompany'>
                and ifnull(op_order.belongleasecompany, '') = ''
            </if>
            <if test='"运管平台" != belongleasecompany'>
                and op_order.belongleasecompany = #{belongleasecompany}
            </if>
        </if>
                <if test='null != minUseTime and "" != minUseTime'>
                    <![CDATA[
                        and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <if test='null != maxUseTime and "" != maxUseTime'>
                    <![CDATA[
                        and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <include refid="getOrderLeaseSQL"></include>
            order by
                op_order.usetime desc
            limit #{iDisplayStart}, #{iDisplayLength}
        </select>
        <select id="getOpWaitgatheringOrderCountByQuery" resultType="int" parameterType="OrderManageQueryParam">
            select
                count(*)
            from
                op_order
            where
                op_order.status = 1 and op_order.orderstatus = "7" and op_order.paymentstatus = "0"
                and op_order.belongleasecompany = #{queryTmpBelongleasecompany}
                <if test='null != orderNo and "" != orderNo'>
                    and op_order.orderno like concat('%', #{orderNo}, '%')
                </if>
                <if test='null != orderType and "" != orderType'>
                    and op_order.ordertype = #{orderType}
                </if>
                <if test='null != userId and "" != userId'>
                    and op_order.userid = #{userId}
                </if>
                <if test='null != driverid and "" != driverid'>
                    and op_order.driverid = #{driverid}
                </if>
                <if test='null != ordersource and "" != ordersource'>
                    and op_order.orderno like concat(#{ordersource}, '%')
                </if>
                <if test='null != leasescompanyid and "" != leasescompanyid'>
                    and op_order.companyid = #{leasescompanyid}
                </if>
            <if test='null != belongleasecompany and "" != belongleasecompany'>
                <if test='"运管平台" == belongleasecompany'>
                    and ifnull(op_order.belongleasecompany, '') = ''
                </if>
                <if test='"运管平台" != belongleasecompany'>
                    and op_order.belongleasecompany = #{belongleasecompany}
                </if>
            </if>
                <if test='null != minUseTime and "" != minUseTime'>
                    <![CDATA[
                        and op_order.usetime >= date_format(#{minUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <if test='null != maxUseTime and "" != maxUseTime'>
                    <![CDATA[
                        and op_order.usetime <= date_format(#{maxUseTime}, '%Y-%m-%d %H:%i')
                    ]]>
                </if>
                <include refid="getOrderLeaseSQL"></include>
        </select>

</mapper>