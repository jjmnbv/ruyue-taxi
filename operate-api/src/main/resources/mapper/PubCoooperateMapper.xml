<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.szyciov.operate.mapper.PubCoooperateMapper">

    <select id="queryPubCoooperateData" parameterType="com.szyciov.op.param.QueryPubCoooperateParam" resultType="com.szyciov.op.vo.pubCoooperate.QueryPubCoooperateVo">
        select
            t1.id,
            le.name leasecompanyText,
            coono,
            cootype,
            ifnull((select count(1) from pub_cooresource t2 where t1.companyid=t2.companyid and t1.leasecompanyid=t2.leasecompanyid and t2.status=1), 0) openresource,
            servicetype,
            coostate,
            case when ifnull(coostate,2)=0 or ifnull(coostate,2) =2 then '/'
            else concat(DATE_FORMAT(t1.coostarttime, '%Y.%m.%d'),'-',DATE_FORMAT(t1.cooendtime, '%Y.%m.%d')) end validatetime,
            DATE_FORMAT(reviewtime, '%Y-%m-%d') reviewtime,
            case when ifnull(coostate,2)=2 then reviewtext else '/' end reviewtext,
            DATE_FORMAT(applicationtime, '%Y-%m-%d') applicationtime
        from pub_coooperate t1
        inner join le_leasescompany le on le.id=t1.leasecompanyid
        where 1=1
            and t1.companyid = #{companyid}
            and t1.status=1
            and t1.platformtype='0'
            <if test='null != coono and "" != coono'>
                and instr(t1.coono, #{coono}) > 0
            </if>
            <if test='null != leasecompanyid and "" != leasecompanyid'>
                and t1.leasecompanyid = #{leasecompanyid}
            </if>
            <if test='null != servicetype and "" != servicetype'>
                and t1.servicetype = #{servicetype}
            </if>
            <if test='null != coostate and "" != coostate'>
                and t1.coostate = #{coostate}
            </if>
            <if test='null != applicationtimeStart and "" != applicationtimeStart'>
                and t1.applicationtime >= #{applicationtimeStart}
            </if>
            <if test='null != applicationtimeEnd and "" != applicationtimeEnd'>
                and t1.applicationtime &#60; #{applicationtimeEnd}
            </if>
            order by applicationtime desc
    </select>

    <select id="queryLeasecompany" parameterType="java.lang.String" resultType="com.szyciov.op.vo.pubCoooperate.QueryLeasecompanyVo">
      select distinct
        coo.leasecompanyid id,
        le.name text
      from pub_coooperate coo
      inner join le_leasescompany le on coo.leasecompanyid=le.id
      where coo.status=1 and coo.companyid = #{companyid} order by le.name asc
    </select>
    <update id = "reviewLeasecompany" parameterType="com.szyciov.op.param.ReviewLeasecompanyParam">
        update pub_coooperate
            set coostate=#{coostate},
                coostarttime=#{coostarttime},
                cooendtime=#{cooendtime},
                updater=#{updater},
                updatetime=#{updatetime},
                reviewtext=#{reviewtext},
                reviewtime=#{reviewtime}
        where id=#{id}
    </update>
    <update id = "disableCoooperate" parameterType="com.szyciov.op.param.DisableCoooperateParam">
        update pub_coooperate
        set coostate=#{coostate},
        updater=#{updater},
        updatetime=#{updatetime},
        cooendtime=#{cooendtime}
        where id=#{id}
    </update>

    <select id="queryCooagreementView" parameterType="java.lang.String" resultType="com.szyciov.op.vo.pubCoooperate.QueryCooagreementViewVo">
        select cooname,
              coocontent
        from pub_coooperate t1
        inner join pub_cooagreement t2 on t1.leasecompanyid=t2.leasecompanyid and t1.companyid=t2.companyid
        where t2.status=1
            and t2.platformtype='0'
            and t1.id=#{coooperateId}
            order by t2.updatetime desc
            limit 1
    </select>




</mapper>